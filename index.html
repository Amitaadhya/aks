<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RADNIK QUINCE PORTAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #5A00C9; /* Deeper purple */
      --secondary: #0076FF; /* Brighter, professional blue */
      --dark: #1A202C; /* Slightly lighter dark background */
      --darker: #0E141E; /* Very deep dark for contrast */
      --light: #E2E8F0; /* Off-white for text */
      --accent: #E11D48; /* Vibrant accent color */
      --success: #10B981; /* Standard green */
      --warning: #F59E0B; /* Standard orange */
      --info: #3B82F6; /* Standard blue */
      --purple: #8B5CF6;
      --pink: #EC4899;
      --cyan: #06B6D4;

      --particle-float-x: 1000px; /* For particle animation */
      --login-gradient: linear-gradient(135deg, var(--primary), var(--secondary));
      --input-focus-shadow: 0 0 0 3px rgba(90, 0, 201, 0.5); /* Focus shadow using primary */

      /* Enhanced professional gradients and backgrounds */
      --card-gradient-start: rgba(26, 32, 44, 0.9); /* More opaque card background */
      --card-gradient-end: rgba(14, 20, 30, 0.8); /* Deeper blend */
      --card-border: rgba(255, 255, 255, 0.15); /* Slightly stronger border */
      --modal-bg: linear-gradient(150deg, var(--darker), #1E2734); /* Smoother modal background */
      --header-bg: rgba(15, 23, 42, 0.95); /* More opaque header */
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif; 
      background: linear-gradient(140deg, var(--dark), var(--darker)); /* Slightly angled background */
      color: var(--light); 
      min-height: 100vh; 
      display: flex; 
      flex-direction: column;
      line-height: 1.7; /* Improved line height for readability */
      overflow-x: hidden;
    }
    .particles { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      z-index: -1; 
      overflow: hidden; 
      background: linear-gradient(140deg, var(--dark), var(--darker)); /* Fallback background */
    }
    .particle { 
      position: absolute; 
      background: rgba(255, 255, 255, 0.3); /* Lighter particles */
      border-radius: 50%; 
      pointer-events: none; 
      animation: float 20s infinite linear; /* Slightly slower, more drifting animation */
      filter: blur(2px); /* Softer blur */
    }
    @keyframes float {
      0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-1200px) translateX(var(--particle-float-x)) rotate(900deg); opacity: 0; } /* More dramatic float */
    }

    header {
      width: 100%; 
      padding: 18px 40px; /* More padding */
      background: var(--header-bg); /* Use defined header background */
      backdrop-filter: blur(12px); /* Stronger blur for glassmorphism */
      position: fixed; 
      top: 0; left: 0; 
      z-index: 999; 
      display: flex; 
      justify-content: space-between;
      align-items: center; 
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* Stronger shadow */
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .logo { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      cursor: pointer; 
      transition: transform 0.3s ease; /* Smooth logo hover */
    }
    .logo i { 
      font-size: 2rem; /* Larger icon */
      color: var(--accent); 
      transform: rotate(-10deg); 
      transition: transform 0.4s ease;
    }
    .logo:hover i {
      transform: rotate(360deg);
    }
    .logo:hover {
      transform: scale(1.02);
    }
    h1 {
      font-size: 1.9rem; /* Slightly larger title */
      font-weight: 700; 
      background: linear-gradient(90deg, var(--accent), var(--pink), var(--primary)); /* More vibrant gradient */
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent;
      background-size: 350% 350%; /* Larger gradient area */
      animation: gradient 9s ease infinite; /* Longer animation */
    }
    @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .header-info { 
      display: flex; 
      align-items: center; 
      gap: 25px; /* More space between info elements */
    }
    .user-profile { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      color: rgba(255, 255, 255, 0.95); /* Brighter text */
      font-size: 1rem; /* Larger font */
      background-color: rgba(255, 255, 255, 0.08); /* Slightly more opaque background */
      padding: 6px 15px; 
      border-radius: 30px; 
      border: 1px solid rgba(255,255,255,0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .user-profile:hover {
      transform: scale(1.03);
      box-shadow: 0 5px 15px rgba(90, 0, 201, 0.3); /* Primary color shadow */
    }
    #userProfilePic { 
      width: 40px; /* Larger avatar */
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 3px solid var(--accent); /* Accent border for avatar */
    }
    #userNameText { font-weight: 600; } /* Bolder username */
    .header-info #clock { 
      margin: 0; 
      font-size: 0.95rem; /* Slightly larger clock font */
      color: rgba(255, 255, 255, 0.85); 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      border-left: 1px solid rgba(255,255,255,0.2); /* Separator */
      padding-left: 15px;
    }
    .header-info #clock i { color: var(--cyan); }

    .header-buttons { 
      display: flex; 
      gap: 12px; 
    }
    .header-btn { 
      padding: 9px 18px; /* More padding */
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: #fff; 
      border: none; 
      border-radius: 35px; /* More rounded */
      cursor: pointer; 
      font-size: 0.85rem; /* Slightly larger font */
      font-weight: 500; 
      transition: all 0.3s ease; 
      display: flex; 
      align-items: center; 
      gap: 6px; 
      box-shadow: 0 5px 18px rgba(90, 0, 201, 0.3); /* Primary shadow */
    }
    .header-btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 25px rgba(90, 0, 201, 0.4); /* Stronger shadow on hover */
    }
    .header-btn i { font-size: 1rem; } /* Larger icon in header buttons */
    #userManagementBtn, #portalSettingsBtn, #myProfileBtn, #userProfile { display: none; } /* Hidden by default, shown by JS */

    .popup { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background: rgba(0, 0, 0, 0.85); /* Darker overlay */
      backdrop-filter: blur(8px); /* Stronger blur */
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
      animation: fadeIn 0.3s ease; 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .popup-content {
        background: var(--modal-bg); /* Use the new modal background gradient */
        padding: 45px 55px; /* More padding */
        border-radius: 20px; /* More rounded corners */
        width: 90%;
        max-width: 420px; /* Slightly wider popup */
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7); /* Deeper shadow */
        animation: popupFadeIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid rgba(255, 255, 255, 0.2); /* Stronger border */
        position: relative;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    @keyframes popupFadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    .popup-header {
        color: #fff;
        font-size: 2rem; /* Larger header font */
        margin-bottom: 30px; /* More space below header */
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        text-shadow: 0 4px 10px rgba(0,0,0,0.4); /* Stronger text shadow */
    }
    .popup-header i {
        color: var(--primary);
        font-size: 2.2rem; /* Larger header icon */
    }
    .login-logo {
        margin-bottom: 30px; /* More space below logo */
    }
    .login-logo img {
        width: 80px; /* Larger logo */
        height: 80px;
        border-radius: 25px; /* More rounded */
        border: 5px solid var(--primary); /* Primary border */
        box-shadow: 0 0 25px rgba(90, 0, 201, 0.6); /* Primary shadow */
        transition: transform 0.3s ease;
    }
    .login-logo img:hover {
        transform: scale(1.1) rotate(10deg); /* More pronounced hover effect */
    }

    .input-group {
        margin-bottom: 25px; /* More space between inputs */
        position: relative;
        width: 100%;
    }
    .input-group label {
        display: block;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem; /* Larger label font */
        font-weight: 500;
        transition: all 0.3s ease;
        transform-origin: left center;
        position: absolute;
        top: 18px; /* Adjusted initial position */
        pointer-events: none;
        opacity: 0.8;
    }
    /* Adjusted label animation for better look */
    .input-group input:focus + label, 
    .input-group input:not(:placeholder-shown) + label,
    .input-group textarea:focus + label,
    .input-group textarea:not(:placeholder-shown) + label { 
        transform: translateY(-28px) scale(0.8); /* More vertical shift, slightly larger scale */
        opacity: 1;
        color: var(--primary); /* Primary color for active label */
        left: 50px; 
    }
    .input-group input, .input-group textarea {
        width: 100%;
        padding: 15px 20px 15px 50px; /* More padding, adjusted for icon */
        background: rgba(0, 0, 0, 0.35); /* Slightly darker input background */
        border: 1px solid rgba(255, 255, 255, 0.15); /* Stronger border */
        border-radius: 12px; /* More rounded */
        font-size: 1rem; /* Larger input font */
        color: #fff;
        transition: all 0.3s ease;
        outline: none;
        caret-color: var(--accent); /* Accent cursor color */
    }
    .input-group textarea {
        min-height: 200px; /* A good default height */
        resize: vertical;
        font-family: inherit; /* Ensure it uses the Poppins font */
        padding-top: 20px; /* Extra top padding for the label */
    }
    .input-group input:focus, .input-group textarea:focus {
        border-color: var(--primary);
        box-shadow: var(--input-focus-shadow); /* Use primary color focus shadow */
        background: rgba(0, 0, 0, 0.45); /* Darker on focus */
    }
    .input-group label i {
        margin-right: 12px; /* More space for icon */
        color: var(--info);
        font-size: 1.2rem; /* Larger icon */
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 25px; /* More space */
        justify-content: flex-start;
    }
    .checkbox-group input[type="checkbox"] {
        margin-right: 15px; /* More space */
        accent-color: var(--primary); 
        transform: scale(1.2); /* Larger checkbox */
        border-radius: 6px; /* Slightly rounded checkbox */
    }
    .checkbox-group label {
        color: rgba(255, 255, 255, 0.85); /* Brighter label */
        font-size: 1rem; /* Larger font */
        cursor: pointer;
        margin-bottom: 0; /* Override default */
    }
    
    .login-btn, .action-btn {
        width: 100%;
        padding: 14px; /* More padding */
        background: var(--login-gradient);
        color: #fff;
        border: none;
        border-radius: 12px; /* More rounded */
        font-size: 1.05rem; /* Larger font */
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 15px; 
        box-shadow: 0 8px 25px rgba(90, 0, 201, 0.4); /* Primary shadow */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px; /* More space for icon */
    }
    .login-btn:hover, .action-btn:hover {
        transform: translateY(-4px); /* More pronounced lift */
        box-shadow: 0 12px 30px rgba(90, 0, 201, 0.5); /* Stronger shadow */
    }
    .action-btn.secondary { background: var(--accent); box-shadow: 0 5px 18px rgba(225, 29, 72, 0.3); }
    .action-btn.secondary:hover { box-shadow: 0 8px 25px rgba(225, 29, 72, 0.4); }
    .action-btn.danger { background: linear-gradient(135deg, #E53935, #C62828); box-shadow: 0 5px 18px rgba(229, 57, 53, 0.3); }
    .action-btn.danger:hover { box-shadow: 0 8px 25px rgba(229, 57, 53, 0.4); }

    .forgot-password {
        margin-top: 25px; /* More space */
        margin-bottom: 30px; /* More space */
    }
    .forgot-password a {
        color: var(--accent);
        text-decoration: none;
        font-size: 1rem; /* Larger font */
        transition: all 0.3s ease;
    }
    .forgot-password a:hover {
        text-decoration: underline;
        color: var(--light); /* Lighter on hover */
    }
    .error-message, .success-message, .warning-message {
        font-size: 0.95rem; /* Slightly larger message font */
        margin-top: 10px; 
        text-align: center;
        display: none; 
        padding: 14px 20px; /* More padding */
        border-radius: 12px; /* More rounded */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 15px; /* More space below messages */
        border: 1px solid; /* Add border for definition */
    }
    .error-message { background-color: rgba(225, 29, 72, 0.1); border-color: var(--accent); color: var(--accent); }
    .success-message { background-color: rgba(16, 185, 121, 0.1); border-color: var(--success); color: var(--success); }
    .warning-message { background-color: rgba(245, 158, 11, 0.1); border-color: var(--warning); color: var(--warning); }

    .login-footer {
        margin-top: 35px; /* More space */
        font-size: 0.85rem; /* Slightly larger footer font */
        color: rgba(255, 255, 255, 0.6); /* Slightly brighter footer text */
        text-align: center;
        width: 100%;
    }
    
    /* --- Main Content CSS --- */
    .container {
        flex: 1; 
        max-width: 1440px; /* Wider container */
        width: 100%;
        padding: 110px 30px 50px; /* More padding */
        margin: 0 auto; 
        display: none; 
    }
    #dashboardOverviewSection, #recentLinksSection { display: none; } 
    
    .dashboard-overview { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Wider cards */
      gap: 25px; /* More gap */
      margin-bottom: 40px; /* More space below overview */
    }
    .overview-card { 
      background: var(--card-gradient-start); 
      backdrop-filter: blur(15px); /* Stronger blur */
      border-radius: 15px; /* More rounded corners */
      padding: 25px; 
      border: 1px solid var(--card-border); 
      transition: all 0.4s ease; /* Smoother transitions */
      position: relative; 
      overflow: hidden; 
      cursor: pointer; 
    }
    .overview-card::before { 
      content: ''; 
      position: absolute; 
      top: 50%; left: 50%; 
      transform: translate(-50%, -50%); 
      width: 0; height: 0; 
      background: radial-gradient(circle, rgba(225, 29, 72, 0.35) 0%, transparent 70%); /* More vibrant accent glow */
      border-radius: 15px; 
      transition: width 0.5s ease, height 0.5s ease; 
      opacity: 0.25; 
      z-index: 0; 
    }
    .overview-card:hover {
      transform: translateY(-7px) scale(1.01); /* More pronounced hover effect */
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4); /* Deeper shadow */
      border-color: var(--accent); /* Accent border on hover */
    }
    .overview-card:hover::before { 
      width: 350px; height: 350px; 
    }
    .overview-card h3, .overview-card p, .overview-card .card-footer { 
      position: relative; 
      z-index: 1; 
    }
    .overview-card h3 { 
      font-size: 0.95rem; /* Slightly larger title */
      color: rgba(255, 255, 255, 0.8); /* Brighter text */
      margin-bottom: 12px; /* More space */
      display: flex; 
      align-items: center; 
      gap: 10px; /* More space for icon */
    }
    .overview-card h3 i:first-of-type { 
      font-size: 1.1rem; 
      color: var(--accent); 
    }
    .overview-card p { 
      font-size: 1.8rem; /* Larger value font */
      font-weight: 600; 
      margin: 0; 
      color: var(--light);
    }
    .overview-card .card-value { 
      transition: color 0.3s ease; 
    }
    .overview-card .card-unit { 
      font-size: 1rem; /* Larger unit font */
      color: rgba(255,255,255,0.7); 
      margin-left: 6px;
    }
    .overview-card .card-footer { 
      font-size: 0.85rem; /* Larger footer font */
      color: rgba(255, 255, 255, 0.7); 
      margin-top: 12px; /* More space */
      display: flex; 
      align-items: center; 
      gap: 6px; 
    }
    .overview-card .card-footer i { 
      color: var(--success);
      animation: spin 1.2s linear infinite; /* Slightly slower spin */
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .edit-card-btn { 
      margin-left: auto; 
      color: rgba(255,255,255,0.6); 
      cursor: pointer; 
      font-size: 1em; /* Standard icon size */
      transition: color 0.3s ease; 
      display: none; 
    }
    .edit-card-btn:hover { 
      color: var(--accent); 
    }
    body.admin-mode .edit-card-btn { display: inline-block; }

    .search-filter-container { 
      display: flex; 
      justify-content: space-between; 
      margin-bottom: 35px; /* More space */
      gap: 25px; /* More gap */
      flex-wrap: wrap; 
    }
    .search-container { 
      flex: 1; 
      min-width: 250px; 
    }
    .search-bar { 
      position: relative; 
      width: 100%; 
    }
    .search-bar input { 
      width: 100%; 
      padding: 14px 20px 14px 50px; /* More padding, adjusted for icon */
      background: rgba(255, 255, 255, 0.12); /* Slightly more opaque background */
      border: 1px solid rgba(255, 255, 255, 0.25); /* Stronger border */
      border-radius: 35px; /* More rounded */
      font-size: 0.95rem; /* Larger font */
      color: #fff; 
      transition: all 0.3s ease; 
      caret-color: var(--accent);
    }
    .search-bar input:focus { 
      outline: none; 
      background: rgba(255, 255, 255, 0.18); 
      box-shadow: 0 0 0 4px rgba(90, 0, 201, 0.25); /* Stronger focus shadow */
    }
    .search-bar i { 
      position: absolute; 
      left: 20px; /* Aligned with padding */
      top: 50%; 
      transform: translateY(-50%); 
      color: rgba(255, 255, 255, 0.75); /* Brighter icon */
      font-size: 1.1rem; /* Larger icon */
    }
    .filter-tags { 
      display: flex; 
      gap: 12px; /* More gap */
      flex-wrap: wrap; 
    }
    .filter-tag { 
      padding: 10px 20px; /* More padding */
      background: rgba(255, 255, 255, 0.1); 
      border-radius: 30px; 
      font-size: 0.85rem; /* Larger font */
      cursor: pointer; 
      transition: all 0.3s ease; 
      border: 1px solid rgba(255, 255, 255, 0.15); 
    }
    .filter-tag:hover, .filter-tag.active { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      box-shadow: 0 6px 20px rgba(90, 0, 201, 0.35); /* Primary shadow */
      transform: translateY(-2px);
    }
    
    .section-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 40px 0 20px; /* More margin */
      padding-bottom: 12px; /* More padding */
      border-bottom: 1px solid rgba(255, 255, 255, 0.15); /* Stronger border */
    }
    .section-header h2 { 
      font-size: 1.4rem; /* Larger section titles */
      font-weight: 600; 
      display: flex; 
      align-items: center; 
      gap: 12px; /* More space */
    }
    .section-header h2 i { 
      color: var(--accent); 
    }
    .section-header .action-btn-small { 
      padding: 7px 15px; /* More padding */
      font-size: 0.8rem; 
      background: var(--dark); 
      border: 1px solid rgba(255,255,255,0.25); /* Stronger border */
      color: rgba(255,255,255,0.9); /* Brighter text */
      border-radius: 25px; 
      display: flex; 
      align-items: center; 
      gap: 8px; /* More space */
      transition: all 0.3s ease;
    }
    .section-header .action-btn-small:hover { 
      background: var(--accent); 
      color: white; 
      border-color: var(--accent); 
      transform: translateY(-2px);
    }

    .quick-access { 
      display: flex; 
      gap: 20px; /* More gap */
      margin-bottom: 40px; /* More space */
      flex-wrap: wrap; 
    }
    .quick-btn { 
      padding: 12px 22px; /* More padding */
      background: rgba(255, 255, 255, 0.12); 
      border-radius: 35px; /* More rounded */
      font-size: 1rem; /* Larger font */
      cursor: pointer; 
      transition: all 0.3s ease; 
      border: 1px solid rgba(255, 255, 255, 0.15); 
      display: flex; 
      align-items: center; 
      gap: 10px; /* More space */
    }
    .quick-btn:hover { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      box-shadow: 0 6px 20px rgba(90, 0, 201, 0.35); 
      transform: translateY(-3px);
    }
    .quick-btn i {
      color: var(--accent); 
      font-size: 1.1rem; /* Larger icon */
    }

    .button-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Adjusted minmax */
      gap: 20px; /* More gap */
    }
    /* === ADVANCED BUTTON STYLE === */
    .btn {
      position: relative;
      display: flex;
      align-items: center;
      padding: 20px 25px; /* More padding */
      color: #fff;
      background-color: var(--darker); 
      border: 1px solid rgba(255, 255, 255, 0.15); /* Stronger border */
      border-radius: 15px; /* More rounded */
      text-decoration: none;
      font-size: 1rem; /* Larger font */
      font-weight: 500;
      cursor: pointer;
      overflow: hidden;
      z-index: 1;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background-image: linear-gradient(140deg, var(--card-gradient-end), var(--darker)); /* Angled gradient */
    }
    .btn::before { 
      content: '';
      position: absolute;
      top: -3px; left: -3px; /* More spread for blur */
      width: calc(100% + 6px);
      height: calc(100% + 6px);
      background: inherit; 
      border-radius: inherit;
      filter: blur(15px); /* Stronger blur */
      opacity: 0;
      z-index: -1;
      transition: opacity 0.4s ease;
    }
    .btn::after { 
      content: '';
      position: absolute;
      top: 0;
      left: -150%; 
      width: 100%;
      height: 100%;
      background: linear-gradient(110deg, transparent 15%, rgba(255, 255, 255, 0.4) 50%, transparent 85%); /* More intense sweep */
      transform: skewX(-25deg); 
      transition: left 0.8s ease-in-out; /* Slower sweep */
      z-index: 2;
    }
    .btn:not(.globally-disabled-admin-view):hover { 
      transform: translateY(-6px) scale(1.02); /* More pronounced lift */
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Deeper shadow */
    }
    .btn:not(.globally-disabled-admin-view):hover::before { opacity: 0.7; } /* More intense glow */
    .btn:not(.globally-disabled-admin-view):hover::after { left: 150%; } 
    .btn i:first-child, .btn .btn-text, .btn-tag, .admin-toggle { position: relative; z-index: 3; } 
    .btn i:first-child { margin-right: 15px; /* More space */ font-size: 1.3rem; /* Larger icon */ min-width: 25px; text-align: center; }
    .btn .btn-text { flex-grow: 1; text-align: left; margin-right: 5px; }
    .btn-tag { 
      position: absolute; 
      top: 12px; /* Adjusted position */
      right: 12px; /* Adjusted position */
      background: rgba(0, 0, 0, 0.6); /* Darker tag background */
      padding: 4px 10px; /* More padding */
      border-radius: 30px; 
      font-size: 0.75rem; /* Smaller tag font */
      font-weight: 500; 
      backdrop-filter: blur(5px); /* Stronger blur on tag */
      border: 1px solid rgba(255,255,255,0.15);
    }
    /* === END OF BUTTON STYLE === */

    body.admin-mode .btn.globally-disabled-admin-view { 
      opacity: 0.5; /* More faded when disabled */
      filter: grayscale(70%) brightness(0.6); 
      cursor: default; 
    }
    body.admin-mode .btn.globally-disabled-admin-view:hover { 
      transform: none; 
      box-shadow: none; 
    }

    .admin-toggle { 
      margin-left: auto; 
      padding-left: 10px; 
      font-size: 1.4em; /* Larger toggle icon */
      cursor: pointer; 
      z-index: 5; 
      display: none; 
      transition: color 0.3s ease;
    }
    body.admin-mode .admin-toggle { display: inline-block; }
    .admin-toggle i.fa-toggle-on { color: var(--accent); } 
    .admin-toggle i.fa-toggle-off { color: var(--success); } 

    /* Button Color Classes - mapping for consistency */
    .btn-purple { background-image: linear-gradient(135deg, var(--purple), var(--primary)); }
    .btn-cyan { background-image: linear-gradient(135deg, var(--cyan), #007bff); } 
    .btn-red { background-image: linear-gradient(135deg, #dc3545, #c82333); }
    .btn-green { background-image: linear-gradient(135deg, var(--success), #28a745); }
    .btn-orange { background-image: linear-gradient(135deg, var(--warning), #fd7e14); }
    .btn-blue { background-image: linear-gradient(135deg, var(--info), var(--secondary)); }
    .btn-pink { background-image: linear-gradient(135deg, var(--pink), #d63384); }
    .btn-yellow { background-image: linear-gradient(135deg, #ffc107, #e0a800); }
    
    /* Dynamic Color Mapping */
    .btn-1 { background-image: linear-gradient(135deg, #6a11cb, #2575fc); } .btn-2 { background-image: linear-gradient(135deg, #ec4899, #f43f5e); }
    .btn-3 { background-image: linear-gradient(135deg, #10b981, #059669); } .btn-4 { background-image: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .btn-5 { background-image: linear-gradient(135deg, #f59e0b, #d97706); } .btn-6 { background-image: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .btn-7 { background-image: linear-gradient(135deg, #06b6d4, #0891b2); } .btn-8 { background-image: linear-gradient(135deg, #f97316, #ea580c); }
    .btn-9 { background-image: linear-gradient(135deg, #e879f9, #c026d3); } .btn-10 { background-image: linear-gradient(135deg, #0ea5e9, #0284c7); }
    .btn-11 { background-image: linear-gradient(135deg, #84cc16, #65a30d); } .btn-12 { background-image: linear-gradient(135deg, #facc15, #eab308); }
    .btn-13 { background-image: linear-gradient(135deg, #a78bfa, #9333ea); } .btn-14 { background-image: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .btn-15 { background-image: linear-gradient(135deg, #f472b6, #ec4899); } .btn-16 { background-image: linear-gradient(135deg, #2dd4bf, #14b8a6); }
    .btn-17 { background-image: linear-gradient(135deg, #38bdf9, #10b981); } .btn-18 { background-image: linear-gradient(135deg, #fb923c, #f97316); }
    .btn-19 { background-image: linear-gradient(135deg, #818cf8, #6366f1); } .btn-20 { background-image: linear-gradient(135deg, #a78bfa, #8b5cf6); }
    .btn-21 { background-image: linear-gradient(135deg, #38bdf8, #0ea5e9); } .btn-22 { background-image: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .btn-23 { background-image: linear-gradient(135deg, #22d3ee, #06b6d4); } .btn-24 { background-image: linear-gradient(135deg, #c084fc, #a855f7); }
    .btn-25 { background-image: linear-gradient(135deg, #4f46e5, #4338ca); } .btn-26 { background-image: linear-gradient(135deg, #f43f5e, #e11d48); }
    .btn-27 { background-image: linear-gradient(135deg, #14b8a6, #0d9488); } .btn-28 { background-image: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-info { background-image: linear-gradient(135deg, var(--info), var(--cyan));}

    .recent-links { margin-top: 50px; /* More space */ }
    .recent-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Wider cards */
      gap: 20px; /* More gap */
    }
    .recent-item { 
      background: var(--card-gradient-start); 
      backdrop-filter: blur(15px); /* Stronger blur */
      border-radius: 12px; /* More rounded */
      padding: 20px; /* More padding */
      border: 1px solid var(--card-border); 
      transition: all 0.4s ease; 
      display: flex; 
      align-items: center; 
      gap: 15px; /* More gap */
      cursor: pointer; 
    }
    .recent-item:hover { 
      transform: translateY(-5px) scale(1.01); /* More pronounced hover */
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); 
      border-color: var(--accent); 
    }
    .recent-icon { 
      width: 45px; /* Larger icon container */
      height: 45px; 
      border-radius: 10px; /* More rounded */
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
    }
    .recent-icon i { 
      font-size: 1.4rem; /* Larger icon */
      color: white; 
    }
    .recent-info h4 { 
      font-size: 1rem; /* Larger title */
      margin-bottom: 6px; /* More space */
      color: var(--light);
    }
    .recent-info p { 
      font-size: 0.85rem; /* Larger text */
      color: rgba(255, 255, 255, 0.75); /* Brighter text */
    }
    
    footer { 
      display: none; 
      width: 100%; 
      padding: 25px; /* More padding */
      background: rgba(15, 23, 42, 0.95); /* More opaque */
      backdrop-filter: blur(15px); /* Stronger blur */
      text-align: center; 
      font-size: 1rem; /* Larger font */
      color: rgba(255, 255, 255, 0.75); /* Brighter text */
      border-top: 1px solid rgba(255, 255, 255, 0.15); /* Stronger border */
      margin-top: auto; 
    }
    .footer-content { 
      max-width: 1200px; 
      margin: 0 auto; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }
    .social-links { 
      display: flex; 
      gap: 18px; /* More gap */
      margin-top: 15px; /* More space */
    }
    .social-links a { 
      color: #fff; 
      font-size: 1.4rem; /* Larger icons */
      transition: all 0.3s ease; 
    }
    .social-links a:hover { 
      color: var(--accent); 
      transform: translateY(-4px); 
    }
    
    #backToTop { 
      position: fixed; 
      bottom: 35px; /* Adjusted position */
      right: 35px; /* Adjusted position */
      width: 55px; /* Larger button */
      height: 55px; 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: #fff; 
      border: none; 
      border-radius: 50%; 
      cursor: pointer; 
      font-size: 1.4rem; /* Larger icon */
      transition: all 0.3s ease; 
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
      z-index: 99; 
      display: none; 
      align-items: center; 
      justify-content: center; 
    }
    #backToTop:hover { 
      transform: translateY(-4px) scale(1.08); /* More pronounced hover */
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5); 
    }
    
    #notification { 
      position: fixed; 
      bottom: 35px; 
      left: 50%; 
      transform: translateX(-50%); 
      color: #fff; 
      padding: 14px 30px; /* More padding */
      border-radius: 35px; /* More rounded */
      display: none; 
      z-index: 1000; 
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); 
      animation: slideUp 0.3s ease; 
      display: flex; 
      align-items:center; 
      gap: 10px; 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
    }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
    
    /* Welcome Popup */
    #welcomePopup { 
      position: fixed; 
      top: -150px; 
      right: 20px; 
      background: linear-gradient(140deg, #1E2734, #283240); /* Darker, more professional gradient */
      color: white; 
      padding: 22px; /* More padding */
      border-radius: 15px; /* More rounded */
      border: 1px solid rgba(255, 255, 255, 0.2); /* Stronger border */
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6); /* Deeper shadow */
      z-index: 1002; 
      display: flex; 
      align-items: center; 
      gap: 18px; /* More gap */
      width: 350px; /* Wider popup */
      transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      opacity: 0; 
    }
    #welcomePopup.show { top: 95px; opacity: 1; } /* Positioned below header */
    #welcomePopup.hide { top: -150px; opacity: 0; } 
    #welcomePopup i { font-size: 2rem; color: var(--success); } /* Larger icon */
    #welcomeMessage { flex-grow: 1; }
    #welcomeMessage span { font-size: 1.05rem; } /* Larger text */
    #welcomeMessage b { color: var(--accent); font-weight: 600; }
    #welcomeProgress { 
      position: absolute; 
      bottom: 0; left: 0; 
      height: 5px; /* Thicker progress bar */
      width: 100%; 
      background-color: var(--primary); 
      animation: shrink 5s linear forwards; 
    }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    
    /* Modals */
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 1001; 
      left: 0; top: 0; 
      width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.8); /* Darker overlay */
      backdrop-filter: blur(8px); /* Stronger blur */
      animation: fadeInModal 0.3s ease; 
    }
    @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { 
      background: var(--modal-bg); 
      margin: 5% auto; 
      padding: 30px; /* More padding */
      border: 1px solid rgba(255,255,255,0.2); /* Stronger border */
      border-radius: 20px; /* More rounded */
      width: 90%; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.6); /* Deeper shadow */
      color: var(--light); 
    }
    #userManagementModal .modal-content, #portalSettingsModal .modal-content { max-width: 750px; }
    #editDashboardModal .modal-content, #notepadModal .modal-content, #userProfileModal .modal-content { max-width: 500px; }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding-bottom: 18px; /* More padding */
      margin-bottom: 25px; /* More space */
      border-bottom: 1px solid rgba(255,255,255,0.15); /* Stronger border */
    }
    .modal-header h2 { 
      font-size: 1.7rem; /* Larger modal title */
      font-weight: 600; 
      margin: 0; 
      display: flex; 
      align-items: center; 
      gap: 12px; /* More space */
    }
    .modal-header h2 i { 
      color: var(--accent); 
    }
    .close-btn { 
      color: rgba(255,255,255,0.7); 
      font-size: 2rem; /* Larger close button */
      font-weight: bold; 
      transition: color 0.3s ease; 
    }
    .close-btn:hover, .close-btn:focus { 
      color: var(--accent); 
      text-decoration: none; 
      cursor: pointer; 
    }
    
    /* User Management Modal Specifics */
    .user-management-grid { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 35px; /* More gap */
    }
    .user-management-section { 
      background-color: rgba(0,0,0,0.25); /* Darker section background */
      padding: 25px; /* More padding */
      border-radius: 15px; /* More rounded */
      border: 1px solid rgba(255,255,255,0.08); /* Stronger border */
    }
    .user-management-section h3 { 
      margin-top: 0; 
      margin-bottom: 18px; /* More space */
      font-size: 1.3rem; /* Larger heading */
      border-bottom: 1px solid rgba(255,255,255,0.15); 
      padding-bottom: 10px; 
      display: flex; 
      align-items: center; 
      gap: 10px; /* More space */
    }
    #permissionsList { 
      max-height: 320px; /* Slightly taller list */
      overflow-y: auto; 
      padding-right: 12px; /* Scrollbar padding */
    }
    #permissionsList .permission-item { 
      display: flex; 
      align-items: center; 
      padding: 10px 0; /* More padding */
      border-bottom: 1px solid rgba(255,255,255,0.08); /* Stronger separator */
    }
    #permissionsList .permission-item:last-child { 
      border-bottom: none; 
    }
    #permissionsList .permission-item i { 
      margin-right: 10px; 
      color: var(--info); 
      min-width: 18px; 
      text-align: center;
    }
    #permissionsList .permission-item label { 
      flex-grow: 1; 
      margin-left: 6px; 
      font-size: 1rem; /* Larger font */
      cursor:pointer;
      user-select: none; 
    }
    #permissionsList .permission-item input[type="checkbox"] { 
      transform: scale(1.2); 
      accent-color: var(--primary); 
      cursor:pointer; 
      margin-right: 6px;
    }
    
    /* Notepad Modal Specifics */
    #notepadModal .action-btn-group { 
      display: flex; 
      gap: 15px; 
      margin-top: 25px; /* More space */
    }
    #notepadModal .action-btn-group .action-btn { 
      width: 100%; 
    }

    /* User Profile Modal Specifics */
    #userProfileModal .profile-pic-container { 
      text-align: center; 
      margin-bottom: 25px; /* More space */
    }
    #userProfileModal #profilePicPreview { 
      width: 130px; /* Larger avatar */
      height: 130px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 5px solid var(--primary); /* Primary border */
      box-shadow: 0 0 20px rgba(90, 0, 201, 0.6); /* Primary shadow */
    }
    
    /* Portal Settings Modal Specifics */
    .portal-settings-grid { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 30px; /* More gap */
    }
    .portal-settings-section { 
      background-color: rgba(0,0,0,0.25); 
      padding: 25px; /* More padding */
      border-radius: 15px; /* More rounded */
      border: 1px solid rgba(255,255,255,0.08); 
    }
    .portal-settings-section h3 { 
      margin-top: 0; 
      margin-bottom: 22px; /* More space */
      font-size: 1.3rem; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      border-bottom: 1px solid rgba(255,255,255,0.15); 
      padding-bottom: 10px;
    }
    .color-picker-group { 
      display: flex; 
      align-items: center; 
      gap: 15px; /* More gap */
      margin-bottom: 20px; /* More space */
    }
    .color-picker-group label { 
      flex-basis: 130px; /* Adjusted label width */
      font-weight: 500;
    }
    .color-picker-group input[type="color"] { 
      flex-grow: 1; 
      border: none; 
      background: none; 
      height: 45px; /* Larger color picker */
      border-radius: 10px; /* Rounded picker */
      cursor: pointer;
    }
    .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } 
    .color-picker-group input[type="color"]::-webkit-color-swatch { border-radius: 10px; border: 2px solid rgba(255,255,255,0.4); } /* Stylized swatch */
    .color-picker-group input[type="color"]::-moz-color-swatch { border-radius: 10px; border: 2px solid rgba(255,255,255,0.4); }

    .data-management-buttons .action-btn { margin-top: 10px; }
    #importConfigFileLabel { 
      display: block; 
      width: 100%; 
      padding: 14px; /* More padding */
      background: linear-gradient(135deg, var(--info), var(--cyan)); 
      color: #fff; 
      border: none; 
      border-radius: 12px; /* More rounded */
      font-size: 1rem; 
      font-weight: 500; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      margin-bottom: 15px; 
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35); /* Info gradient shadow */
      text-align: center; 
    }
    #importConfigFileLabel:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.45); 
    }
    #importConfigFile { display: none; } 

    #customLinksList { 
      list-style: none; 
      padding: 0; 
      max-height: 220px; /* Taller list */
      overflow-y: auto; 
      margin-top:15px; 
    }
    #customLinksList li { 
      background: rgba(255,255,255,0.08); /* Brighter background */
      padding: 12px 18px; /* More padding */
      border-radius: 10px; /* More rounded */
      margin-bottom: 12px; /* More space */
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      border: 1px solid rgba(255,255,255,0.15); /* Stronger border */
    }
    #customLinksList li .link-details { 
      display: flex; 
      flex-direction: column; 
      flex-grow: 1; 
      margin-right: 18px; /* More space */
    }
    #customLinksList li .link-title { 
      font-weight: 500; 
      display: flex;
      align-items: center;
      gap: 10px; 
      color: var(--light);
    }
    #customLinksList li .link-title i {
      color: var(--info);
      font-size: 1.2rem; /* Larger icon */
    }
    #customLinksList li .link-url { 
      font-size: 0.85rem; /* Larger URL text */
      color: rgba(255,255,255,0.7); 
      word-break: break-all; 
    }
    #customLinksList li .link-actions button { 
      background: transparent; 
      border: none; 
      color: rgba(255,255,255,0.8); /* Brighter icons */
      cursor: pointer; 
      padding: 6px; /* More padding */
      font-size: 1rem; /* Larger icon */
      transition: color 0.3s ease; 
    }
    #customLinksList li .link-actions button:hover { 
      color: var(--accent); 
    }
    #customLinksList li .link-actions button.edit-btn:hover { 
      color: var(--info); 
    }
    #customLinksList li .link-actions button.view-btn:hover {
      color: var(--success);
    }

    /* --- Responsive Adjustments for Scaling and Layout --- */
    @media (min-width: 768px) {
        .user-management-grid { grid-template-columns: 1fr 1.5fr; }
        .portal-settings-grid { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); } /* Wider settings cards */
    }
    @media (max-width: 1200px) {
        .dashboard-overview { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); } /* Adjusted for larger screens */
    }
    @media (max-width: 992px) {
        .button-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); } /* Adjusted button grid */
    }
    @media (max-width: 768px) {
      .popup-content {
        padding: 35px 45px;
        max-width: 90%;
      }
      header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 15px 25px; /* Adjusted padding */
      }
      .header-info {
        margin-top: 0;
        gap: 20px; /* Adjusted gap */
      }
      .header-buttons {
        margin-top: 0;
        gap: 10px; /* Adjusted gap */
      }
      h1 { font-size: 1.7rem; } /* Slightly smaller H1 */
      .dashboard-overview { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 576px) {
      .popup-content {
        padding: 30px 25px;
        max-width: 95%; 
      }
      .popup-header {
        font-size: 1.8rem; 
        margin-bottom: 28px;
      }
      .login-logo img {
        width: 75px; 
        height: 75px;
      }
      .input-group { margin-bottom: 22px; }
      .input-group label { font-size: 0.95rem; }
      .input-group input { padding: 13px 18px 13px 48px; font-size: 1rem; }
      .input-group input:focus + label, 
      .input-group input:not(:placeholder-shown) + label {
        transform: translateY(-27px) scale(0.75); 
        left: 48px; 
      }
      .checkbox-group { margin-bottom: 22px; }
      .login-btn, .action-btn { padding: 13px; font-size: 1.05rem; margin-bottom: 17px; }
      .forgot-password { margin-top: 22px; margin-bottom: 28px; }

      header {
        flex-direction: column;
        padding: 15px;
        gap: 12px;
        align-items: flex-start;
      }
      .header-info {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        margin-top: 12px;
        width: 100%;
      }
      .user-profile {
        justify-content: space-between;
        width: 100%;
      }
      .header-buttons {
        margin-top: 12px;
        width: 100%;
        justify-content: flex-start; 
        overflow-x: auto; 
        white-space: nowrap; 
        padding-bottom: 8px; 
      }
      .header-buttons .header-btn {
        font-size: 0.78rem; 
        padding: 7px 12px;
      }
      h1 { font-size: 1.6rem; }
      .dashboard-overview { grid-template-columns: 1fr; }
      .search-filter-container { flex-direction: column; gap: 20px; }
      .filter-tags { justify-content: center; }
      .button-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Particle Background -->
  <div class="particles" id="particles"></div>

  <!-- Header -->
  <header>
    <div class="logo" onclick="window.location.reload()"> <!-- Make logo clickable to refresh -->
      <i class="fas fa-leaf"></i><h1>RADNIK QUINCE PORTAL</h1> <!-- Changed icon to leaf -->
    </div>
    <div class="header-info">
        <div class="user-profile" id="userProfile">
            <img id="userProfilePic" src="" alt="User Avatar">
            <span id="userNameText"></span>
        </div>
        <p id="clock"></p>
    </div>
    <div class="header-buttons">
      <!-- Admin/Settings Buttons -->
      <button class="header-btn" id="portalSettingsBtn" onclick="openPortalSettingsModal()"><i class="fas fa-cogs"></i> Settings</button>
      <button class="header-btn" id="userManagementBtn" onclick="openUserManagementModal()"><i class="fas fa-users-cog"></i> Users</button>
      
      <!-- User Specific Buttons -->
      <button class="header-btn" id="myProfileBtn" onclick="openUserProfileModal()"><i class="fas fa-user-edit"></i> My Profile</button>
      
      <!-- General Buttons -->
      <button class="header-btn" onclick="openTaskManagerModal()"><i class="fas fa-tasks"></i> Tasks</button>
      <button class="header-btn" onclick="openNotepadModal()"><i class="fas fa-sticky-note"></i> Notepad</button>
      <button class="header-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </header>

  <!-- Login Popup -->
  <div class="popup" id="loginPopup">
    <div class="popup-content">
      <div class="login-logo">
        <img src="https://i.postimg.cc/g07QV872/Screenshot-2025-07-12-102927.png" alt="Portal Logo"> <!-- Kept the original logo -->
      </div>
      <h2 class="popup-header"><i class="fas fa-leaf"></i> Welcome AKS!</h2> <!-- Changed lock icon to leaf -->
      
      <div class="input-group">
        <input type="text" id="username" placeholder=" " required> 
        <label for="username"><i class="fas fa-user"></i> Username</label>
      </div>
      
      <div class="input-group">
        <input type="password" id="password" placeholder=" " required>
        <label for="password"><i class="fas fa-key"></i> Password</label>
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Remember Me</label>
      </div>
      
      <button class="login-btn" onclick="validateLogin()">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
      
      <p class="forgot-password"><a href="#">Forgot Password?</a></p>
      
      <p class="error-message" id="errorMessage"></p>
      
      <div class="login-footer">
        © 2025 Radnik Exports. All rights reserved.
      </div>
    </div>
  </div>

  <!-- Welcome Popup Notification -->
  <div id="welcomePopup">
      <i class="fas fa-rocket"></i> <!-- Rocket icon for a sense of progress -->
      <div id="welcomeMessage"></div>
      <div id="welcomeProgress"></div>
  </div>

  <!-- Modals -->
  <!-- User Profile Modal -->
  <div id="userProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-user-cog"></i> My Profile Settings</h2>
            <span class="close-btn" onclick="closeUserProfileModal()">×</span>
        </div>
        <div id="userProfileMessage" class="message-container"></div> <!-- Message display div -->
        <div class="profile-pic-container">
            <img id="profilePicPreview" src="" alt="Profile Preview">
        </div>
        <div class="input-group">
            <input type="text" id="profilePicUrl" placeholder=" " required>
            <label for="profilePicUrl"><i class="fas fa-image"></i> Profile Picture URL</label>
        </div>
        <div class="input-group">
            <input type="password" id="profileNewPassword" placeholder=" ">
            <label for="profileNewPassword"><i class="fas fa-key"></i> New Password (leave blank)</label>
        </div>
        <button class="action-btn" onclick="saveUserProfile()"><i class="fas fa-save"></i> Save Changes</button>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="userManagementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><h2><i class="fas fa-users-cog"></i> User Management</h2><span class="close-btn" onclick="closeUserManagementModal()">×</span></div>
      <div id="userManagementMessage" class="message-container"></div>
      <div class="user-management-grid">
        <!-- Create User Section -->
        <div class="user-management-section">
          <h3><i class="fas fa-user-plus"></i> Create New User</h3>
          <div class="input-group">
            <input type="text" id="newUsername" placeholder=" " required>
            <label for="newUsername"><i class="fas fa-user-tag"></i> Username</label>
          </div>
          <div class="input-group">
            <input type="password" id="newPassword" placeholder=" " required>
            <label for="newPassword"><i class="fas fa-asterisk"></i> Password</label>
          </div>
          <button class="action-btn" onclick="handleCreateUser()"><i class="fas fa-plus-circle"></i> Create User</button>
        </div>
        <!-- Edit Permissions Section -->
        <div class="user-management-section">
          <h3><i class="fas fa-user-edit"></i> Edit User Permissions</h3>
          <div class="input-group">
            <select id="selectUserForPermissions" onchange="loadPermissionsForSelectedUser()">
              <option value="">-- Select User --</option>
            </select>
            <label for="selectUserForPermissions"><i class="fas fa-user-check"></i> Select User</label>
          </div>
          <div id="permissionsContainer" style="display:none;">
            <h4><i class="fas fa-tasks"></i> Button Access Permissions:</h4>
            <div id="permissionsList"></div>
            <button class="action-btn" onclick="handleSavePermissions()" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Permissions</button>
            <button class="action-btn secondary" onclick="handleDeleteUser()" style="margin-top: 10px;" id="deleteUserBtn" disabled><i class="fas fa-user-times"></i> Delete User</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Dashboard Modal -->
  <div id="editDashboardModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-tachometer-alt-edit"></i> Edit Dashboard Data</h2>
            <span class="close-btn" onclick="closeEditDashboardModal()">×</span>
        </div>
        <div id="editDashboardMessage" class="message-container"></div>
        <input type="hidden" id="editingCardId">
        <div class="input-group">
            <input type="text" id="cardValueInput" placeholder=" " required>
            <label for="cardValueInput"><i class="fas fa-pencil-alt"></i> Value</label>
        </div>
        <div class="input-group">
            <input type="text" id="cardUnitInput" placeholder=" ">
            <label for="cardUnitInput"><i class="fas fa-tag"></i> Unit (e.g., cr, pcs)</label>
        </div>
        <button class="action-btn" onclick="handleSaveDashboardData()"><i class="fas fa-save"></i> Save Data</button>
    </div>
  </div>

  <!-- Notepad Modal -->
  <div id="notepadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-sticky-note"></i> My Notepad</h2>
            <span class="close-btn" onclick="closeNotepadModal()">×</span>
        </div>
        <div class="input-group">
            <textarea id="notepadTextarea" placeholder=" "></textarea>
            <label for="notepadTextarea"><i class="fas fa-pen-alt"></i> Your Notes</label>
        </div>
        <div class="action-btn-group">
            <button class="action-btn" onclick="saveNotepadContent()"><i class="fas fa-save"></i> Save Notes</button>
            <button class="action-btn secondary" onclick="closeNotepadModal()"><i class="fas fa-times-circle"></i> Close</button>
        </div>
    </div>
  </div>

  <!-- Portal Settings Modal -->
  <div id="portalSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-tools"></i> Portal Settings & Management</h2>
            <span class="close-btn" onclick="closePortalSettingsModal()">×</span>
        </div>
        <div id="portalSettingsMessage" class="message-container"></div>
        
        <!-- Custom Links Management -->
        <div class="portal-settings-section">
            <h3><i class="fas fa-link"></i> Manage Quick Links</h3>
            <input type="hidden" id="editingCustomLinkId">
            <div class="input-group">
                <input type="text" id="customLinkText" placeholder=" " required>
                <label for="customLinkText"><i class="fas fa-closed-captioning"></i> Link Text</label>
            </div>
            <div class="input-group">
                <input type="url" id="customLinkUrl" placeholder=" " required>
                <label for="customLinkUrl"><i class="fas fa-external-link-alt"></i> Link URL</label>
            </div>
            <div class="input-group">
                <input type="text" id="customLinkIcon" placeholder=" ">
                <label for="customLinkIcon"><i class="fab fa-font-awesome-flag"></i> Icon Class (e.g., fas fa-link)</label>
            </div>
             <div class="input-group">
                <input type="text" id="customLinkColorClass" placeholder=" ">
                <label for="customLinkColorClass"><i class="fas fa-palette"></i> Button Color Class (e.g., btn-1, btn-info)</label>
            </div>
            <div class="input-group">
                <input type="text" id="customLinkTags" placeholder=" ">
                <label for="customLinkTags"><i class="fas fa-tags"></i> Tags (comma-separated)</label>
            </div>
            <button class="action-btn" id="addOrUpdateCustomLinkBtn" onclick="handleAddOrUpdateCustomLink()"><i class="fas fa-plus-circle"></i> Add Link</button>
            
            <h4 style="margin-top: 25px; margin-bottom: 12px;"><i class="fas fa-list-alt"></i> Existing Links:</h4>
            <ul id="customLinksList"></ul>
        </div>

        <!-- Theme and Particle Settings -->
        <div class="portal-settings-grid" style="margin-top: 30px;">
            <div class="portal-settings-section">
                <h3><i class="fas fa-palette"></i> Theme Customization</h3>
                <div class="color-picker-group">
                    <label for="primaryColorPicker"><i class="fas fa-fill-drip"></i> Primary Color:</label>
                    <input type="color" id="primaryColorPicker">
                </div>
                <div class="color-picker-group">
                    <label for="accentColorPicker"><i class="fas fa-highlighter"></i> Accent Color:</label>
                    <input type="color" id="accentColorPicker">
                </div>
                <button class="action-btn" onclick="saveThemeSettings()"><i class="fas fa-paint-brush"></i> Apply Colors</button>
            </div>

            <div class="portal-settings-section">
                <h3><i class="fas fa-atom"></i> Particle Effects</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="particleToggle">
                    <label for="particleToggle">Enable Particle Background</label>
                </div>
                 <button class="action-btn" onclick="resetDefaultThemeAndParticles()"><i class="fas fa-undo"></i> Reset Visuals</button>
            </div>
        </div>
        
        <!-- Data Management -->
        <div class="portal-settings-section data-management-buttons" style="margin-top: 30px;">
            <h3><i class="fas fa-database"></i> Data Management</h3>
            <button class="action-btn" onclick="exportPortalConfig()"><i class="fas fa-file-export"></i> Export Configuration</button>
            <label for="importConfigFile" id="importConfigFileLabel"><i class="fas fa-file-import"></i> Import Configuration</label>
            <input type="file" id="importConfigFile" accept=".json" onchange="handleImportConfig(event)">
            <button class="action-btn danger" onclick="clearAllPortalData()"><i class="fas fa-skull-crossbones"></i> Clear All Data</button>
        </div>
    </div>
  </div>

  <!-- Task Manager Modal -->
  <div id="taskManagerModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2><i class="fas fa-tasks"></i> Task Manager</h2>
            <span class="close-btn" onclick="closeTaskManagerModal()">×</span>
        </div>
        <div id="taskManagerMessage" class="message-container"></div>
        <div class="user-management-grid">
            <!-- Create/Edit Task Section -->
            <div class="user-management-section">
                <h3 id="taskFormTitle"><i class="fas fa-plus-circle"></i> Create New Task</h3>
                <input type="hidden" id="editingTaskId">
                <div class="input-group">
                    <input type="text" id="taskTitle" placeholder=" " required>
                    <label for="taskTitle"><i class="fas fa-heading"></i> Task Title</label>
                </div>
                <div class="input-group">
                    <textarea id="taskDescription" placeholder=" " style="min-height: 100px;"></textarea>
                    <label for="taskDescription"><i class="fas fa-align-left"></i> Description</label>
                </div>
                <div class="input-group">
                    <input type="date" id="taskDueDate" placeholder=" " style="color-scheme: dark;">
                    <label for="taskDueDate"><i class="fas fa-calendar-alt"></i> Due Date</label>
                </div>
                <div class="input-group">
                    <select id="taskAssignee">
                        <option value="">-- Assign to User --</option>
                    </select>
                    <label for="taskAssignee"><i class="fas fa-user-check"></i> Assign To</label>
                </div>
                <div class="input-group">
                    <select id="taskPriority">
                        <option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="urgent">Urgent</option>
                    </select>
                    <label for="taskPriority"><i class="fas fa-exclamation-triangle"></i> Priority</label>
                </div>
                <div class="input-group">
                    <input type="text" id="taskCategory" placeholder=" " list="taskCategoriesDatalist">
                    <label for="taskCategory"><i class="fas fa-tags"></i> Category (e.g., Work, Personal)</label>
                    <datalist id="taskCategoriesDatalist"></datalist>
                </div>
                <button class="action-btn" onclick="handleSaveTask()"><i class="fas fa-save"></i> Save Task</button>
                <button class="action-btn secondary" onclick="resetTaskForm()" style="display:none;" id="cancelEditTaskBtn"><i class="fas fa-times"></i> Cancel Edit</button>
            </div>
            <!-- Task List Section -->
            <div class="user-management-section">
                <h3><i class="fas fa-list-ul"></i> Task List</h3>
                <div class="task-view-switcher">
                    <button id="taskViewListBtn" class="task-view-btn active" onclick="switchTaskView('list')"><i class="fas fa-list"></i> List</button>
                    <button id="taskViewBoardBtn" class="task-view-btn" onclick="switchTaskView('board')"><i class="fas fa-th-large"></i> Board</button>
                </div>
                <div class="task-list-header">
                    <div class="task-summary" id="taskSummary"></div>
                    <div class="task-controls">
                        <div class="task-search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="taskSearchInput" placeholder="Search tasks..." oninput="renderCurrentTaskView()">
                        </div>
                        <select id="taskSortSelect" onchange="handleTaskSortChange(this.value)">
                            <option value="createdAt">Sort by Creation Date</option>
                            <option value="dueDate">Sort by Due Date</option>
                            <option value="priority">Sort by Priority</option>
                        </select>
                    </div>
                </div>
                <div id="taskFilters" class="task-filters">
                    <!-- Filter buttons will be rendered here by JavaScript -->
                </div>
                <div class="task-view-container">
                    <div id="taskListView" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                        <!-- List view tasks will be rendered here -->
                    </div>
                    <div id="taskBoardView" style="display: none;">
                        <!-- Kanban board view will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
  <style>
    /* --- Task Manager Enhancements --- */
    #taskManagerModal .user-management-grid {
        grid-template-columns: 1fr; /* Default for mobile */
    }
    @media (min-width: 850px) {
        #taskManagerModal .user-management-grid {
            grid-template-columns: 1fr 1.5fr; /* Form on left, list on right */
        }
    }
    .task-view-switcher { display: flex; gap: 5px; margin-bottom: 15px; background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 5px; }
    .task-view-btn { flex: 1; padding: 8px; background: transparent; border: none; color: var(--light); border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .task-view-btn.active { background-color: var(--primary); }
    .task-view-btn:not(.active):hover { background-color: rgba(255,255,255,0.1); }

    .task-view-container { position: relative; min-height: 400px; }
    #taskEmptyState { display: none; text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; }
    #taskEmptyState i { font-size: 3rem; margin-bottom: 15px; display: block; color: var(--primary); opacity: 0.5; }
    #taskEmptyState h4 { font-size: 1.2rem; margin-bottom: 5px; }

    .task-list-header { margin-bottom: 15px; }
    .task-summary { font-size: 0.9rem; color: var(--light); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .task-summary .progress-bar { flex-grow: 1; height: 8px; background-color: rgba(255,255,255,0.1); border-radius: 4px; margin-left: 15px; overflow: hidden; }
    .task-summary .progress-bar-inner { height: 100%; background: var(--success); border-radius: 4px; transition: width 0.5s ease; }
    .task-controls { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .task-search-bar { position: relative; flex-grow: 1; }
    .task-search-bar input { width: 100%; padding: 8px 15px 8px 35px; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); border-radius: 8px; color: white; font-size: 0.9rem; }
    .task-search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.5); }
    #taskSortSelect, #taskPriority {
        padding: 8px 15px;
        background: rgba(0,0,0,0.2);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23FFFFFF%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%27%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 12px top 50%;
        background-size: .65em auto;
        padding-right: 30px;
    }
    #taskPriority { width: 100%; }
    #taskSortSelect { flex-shrink: 0; }

    .task-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    .task-filter-btn {
        padding: 6px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .task-filter-btn:hover, .task-filter-btn.active {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }
    .task-item { background: rgba(255,255,255,0.08); padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 5px solid var(--info); transition: all 0.3s ease; position: relative; }
    .task-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.25); border-color: var(--accent); }
    .task-item.completed { border-left-color: var(--success); text-decoration: line-through; opacity: 0.7; }
    .task-item.completed .task-title, .task-item.completed .task-description { text-decoration: line-through; color: rgba(255,255,255,0.6); }
    .task-item.overdue { border-left-color: var(--accent); }
    .task-header { display: flex; justify-content: space-between; align-items: flex-start; font-weight: 600; margin-bottom: 8px; }
    .task-title { font-size: 1.1rem; margin-right: 10px; }
    .task-meta-container { display: flex; flex-wrap: wrap; gap: 5px 15px; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .task-meta-item { display: flex; align-items: center; gap: 6px; }
    .task-meta-item i { color: var(--info); }
    .task-description { font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 15px; line-height: 1.6; }
    .task-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .task-actions button { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
    .task-actions button.complete-btn:hover { background: var(--success); border-color: var(--success); }
    .task-actions button.edit-btn:hover { background: var(--info); border-color: var(--info); }
    .task-actions button.delete-btn:hover { background: var(--accent); border-color: var(--accent); }
    .task-item.completed .complete-btn { background: var(--success); }
    .task-category-badge {
        background: rgba(255, 255, 255, 0.15);
        color: var(--light);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        flex-shrink: 0;
    }
    .priority-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; color: white; }
    .priority-low { background-color: var(--info); } .priority-medium { background-color: var(--success); }
    .priority-high { background-color: var(--warning); color: var(--darker); } .priority-urgent { background-color: var(--accent); }

    /* Kanban Board Styles */
    #taskBoardView { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 420px; overflow-y: auto; padding: 5px; }
    .kanban-column { background-color: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
    .kanban-column-header { padding-bottom: 10px; margin-bottom: 15px; border-bottom: 2px solid; font-weight: 600; font-size: 1.1rem; }
    .kanban-column[data-status="pending"] .kanban-column-header { border-color: var(--info); }
    .kanban-column[data-status="completed"] .kanban-column-header { border-color: var(--success); }
    .kanban-cards { flex-grow: 1; min-height: 300px; display: flex; flex-direction: column; gap: 12px; }
    .kanban-card { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; cursor: grab; border-left: 4px solid; transition: all 0.3s ease; }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .kanban-card.dragging { opacity: 0.5; transform: scale(0.98); }
    .kanban-column.drag-over { background-color: rgba(90, 0, 201, 0.2); }
    .kanban-card-title { font-weight: 600; margin-bottom: 8px; }
    .kanban-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: rgba(255,255,255,0.7); }
    .kanban-card-assignee { display: flex; align-items: center; gap: 5px; }
    .kanban-card-assignee img { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }
    .kanban-card[data-priority="low"] { border-left-color: var(--info); }
    .kanban-card[data-priority="medium"] { border-left-color: var(--success); }
    .kanban-card[data-priority="high"] { border-left-color: var(--warning); }
    .kanban-card[data-priority="urgent"] { border-left-color: var(--accent); }
    .kanban-card.overdue .kanban-card-meta { color: var(--accent); font-weight: bold; }
  </style>


  <!-- Main Content Area -->
  <div class="container">
    <!-- Dashboard Overview Section -->
    <div class="dashboard-overview" id="dashboardOverviewSection">
      <div class="overview-card" data-card-id="ggnSaleQty" onclick="openEditDashboardModal('ggnSaleQty')">
        <h3><i class="fas fa-boxes-stacked"></i> GGN/Total Quince Sale Qty <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3>
        <p><span class="card-value">6,89,757</span> <span class="card-unit">pcs</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">just now</span></div>
      </div>
      <div class="overview-card" data-card-id="ggnSaleValue" onclick="openEditDashboardModal('ggnSaleValue')">
        <h3><i class="fas fa-dollar-sign"></i> GGN/Total Quince Sale Value <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3> <!-- Changed Rupee to Dollar sign for broader appeal -->
        <p><span class="card-value">GGN/Total Quince Sale Value
₹99.22/-</span> <span class="card-unit">cr</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">today</span></div>
      </div>
      <div class="overview-card" data-card-id="noidaSaleQty" onclick="openEditDashboardModal('noidaSaleQty')">
        <h3><i class="fas fa-cubes"></i> NOIDA/Total Quince Sale Qty <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3> <!-- Changed box-open to cubes for variety -->
        <p><span class="card-value">1,22,332</span> <span class="card-unit">pcs</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">today</span></div>
      </div>
      <div class="overview-card" data-card-id="noidaSaleValue" onclick="openEditDashboardModal('noidaSaleValue')">
        <h3><i class="fas fa-chart-line"></i> NOIDA/Total Quince Sale Value <i class="fas fa-edit edit-card-btn" title="Edit Data"></i></h3> <!-- Changed money-bill to chart-line -->
        <p><span class="card-value">₹16.98/-</span> <span class="card-unit">cr</span></p>
        <div class="card-footer"><i class="fas fa-sync-alt"></i> Updated <span class="card-update-time">2 days ago</span></div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-container">
      <div class="search-container">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search links by name or tag...">
        </div>
      </div>
      <div class="filter-tags">
        <div class="filter-tag active" data-filter="all">All</div>
        <div class="filter-tag" data-filter="finance">Finance</div>
        <div class="filter-tag" data-filter="sales">Sales</div>
        <div class="filter-tag" data-filter="inventory">Inventory</div>
        <div class="filter-tag" data-filter="reports">Reports</div>
        <div class="filter-tag" data-filter="tools">Tools</div>
        <div class="filter-tag" data-filter="custom">Custom</div> 
      </div>
    </div>

    <!-- Quick Access Buttons -->
    <div class="quick-access">
      <div class="quick-btn" onclick="filterByTagManual('finance')"><i class="fas fa-file-invoice-dollar"></i> Finance</div>
      <div class="quick-btn" onclick="filterByTagManual('sales')"><i class="fas fa-chart-bar"></i> Sales Data</div>
      <div class="quick-btn" onclick="filterByTagManual('inventory')"><i class="fas fa-cubes"></i> Inventory</div> <!-- Changed boxes to cubes -->
      <div class="quick-btn" onclick="filterByTagManual('reports')"><i class="fas fa-file-pdf"></i> Reports</div>
    </div>

    <!-- All Quick Links Section -->
    <div class="section-header">
      <h2><i class="fas fa-link"></i> All Quick Links</h2>
    </div>
    <div class="button-grid" id="buttonContainer">
      <!-- Predefined Links -->
      <a href="https://docs.google.com/spreadsheets/d/1c4VbDj3CCp_Lr2MCpoJXmlp2K9qP6L3pIA0eZq52PDM/edit?gid=2065470756#gid=2065470756" class="btn btn-12" target="_blank" data-tags="reports,sales" data-id="quince-2024-sale">
        <i class="fas fa-database"></i><span class="btn-text">QUINCE 2024 SALE DATA</span><span class="btn-tag">Reports</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1sehWq-1kvNwl0qZWOpkhapuk9mam0FjKAoJvHMV9U5o/edit?usp=sharing" class="btn btn-13" target="_blank" data-tags="inventory,operations" data-id="maersk-stock-data">
        <i class="fas fa-ship"></i><span class="btn-text">MAERSK Stock Data</span><span class="btn-tag">Inventory</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/17RWCZ62o2nRvMgZjfi_fZ6AyBQ0YmHNoIp-CCRSxJjg/edit?gid=407320691#gid=407320691" class="btn btn-14" target="_blank" data-tags="sales" data-id="quince-2025-pos">
        <i class="fas fa-shopping-cart"></i><span class="btn-text">QUINCE 2025 POS DATA</span><span class="btn-tag">Sales</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1PnetSLtEPxot9N3KlB_ydbzNccAF5qMnDMRmYLo6ZLs/edit?gid=0#gid=0" class="btn btn-yellow" target="_blank" data-tags="finance,reports,sales" data-id="quince-invoice-summary-new">
        <i class="fas fa-file-invoice-dollar"></i><span class="btn-text">QUINCE_INVOICE SUMMARY</span><span class="btn-tag">Account</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1riS3U9aPW7s8SQmqaZkGrb2fHVEdDbJdHxwdygaeKXc/edit?gid=1345083956#gid=1345083956" class="btn btn-purple" target="_blank" data-tags="sales,reports" data-id="ggn-sales-overview">
        <i class="fas fa-chart-line"></i><span class="btn-text">GGN-186-S-GRAPH CHART</span><span class="btn-tag">Reports</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/15Xma9DRkRectWPqUKDQlr5yZQMtCfQ2Bxa_J5vU-Es0/edit?gid=1345083956#gid=1345083956" class="btn btn-green" target="_blank" data-tags="sales,reports" data-id="noida-sales-overview">
        <i class="fas fa-chart-bar"></i><span class="btn-text">NOIDA-S-GRAPH CHART</span><span class="btn-tag">Reports</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1f7bODkOgwvN_i-nWItzn_67IZv0EqXxAqr2v-ZRQ8Vg/edit?gid=685323596#gid=685323596" class="btn btn-red" target="_blank" data-tags="reports,sales" data-id="projection-vs-actual">
        <i class="fas fa-project-diagram"></i><span class="btn-text">PROJECTION VS ACTUAL</span><span class="btn-tag">Reports</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1QzAuxxuLUz60iWbdiVGzAFDjXY0RSZIda_0VOhbloEU/edit?gid=1012800260#gid=1012800260" class="btn btn-orange" target="_blank" data-tags="reports,sales" data-id="projection-vs-sales">
        <i class="fas fa-chart-pie"></i><span class="btn-text">PROJECTION VS SALES REPORT</span><span class="btn-tag">Reports</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1JFI22zsy2Pa5d2lq4dcEeCZIg7rqFaBMYPzniBdlhMc/edit?gid=874524179#gid=874524179" class="btn btn-blue" target="_blank" data-tags="inventory" data-id="quince-order-chart-ss25">
        <i class="fas fa-cubes"></i><span class="btn-text">QUINCE ORDER CHART -SS25</span><span class="btn-tag">Inventory</span> <!-- Changed icon -->
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1LZa3JvfEdt-9cdQkEmsEluwurMoDzmsXIyFWNpAcnfs/edit?gid=1102120828#gid=1102120828" class="btn btn-cyan" target="_blank" data-tags="inventory" data-id="prepement-2025-ggn">
        <i class="fas fa-boxes"></i><span class="btn-text">PREPEMENT 2025-GGN</span><span class="btn-tag">Inventory</span>
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1BbdX2fcJ8FZlNfaSBqhX-q6YIEt-w-6KJdVixafttCg/edit?gid=588837062#gid=588837062" class="btn btn-pink" target="_blank" data-tags="tools" data-id="missing-data-dhl-ups-fedex">
        <i class="fas fa-search"></i><span class="btn-text">MISSING DATA DHL-UPS-FEDEX</span><span class="btn-tag">Tools</span>
      </a>
       <a href="https://docs.google.com/spreadsheets/d/1l2CnQrl9YEfOFAoiqj82DYwJ-zQWYqCX5HuL87ffRlw/edit?gid=2040776333#gid=2040776333" class="btn btn-pink" target="_blank" data-tags="inventory" data-id="quince-hk-ship-data">
        <i class="fas fa-boxes"></i><span class="btn-text">Quince Hong Kong Ship Data</span><span class="btn-tag">Inventory</span>
      </a>
      <!-- New Link -->
      <a href="https://script.google.com/macros/s/AKfycbw6qke8xOhYaqaxcjFOgp-_wtWAwXEAfVqJA8e6-A/dev" class="btn btn-green" target="_blank" data-tags="reports,finance,sales" data-id="revenue-chargeback-report">
        <i class="fas fa-file-excel"></i><span class="btn-text">GGN Revenue & Chargeback Summary</span><span class="btn-tag">Reports</span>
      </a>
	  <a href="https://script.google.com/macros/s/AKfycbw1Dpw--Ar3rNg3IgPn3e32gpUODmv_O12053XHUYc/dev" class="btn btn-green" target="_blank" data-tags="reports,finance,sales" data-id="revenue-chargeback-report">
        <i class="fas fa-file-excel"></i><span class="btn-text">NOIDA Revenue & Chargeback Summary</span><span class="btn-tag">Reports</span>
      </a>
	  <a href="https://script.google.com/macros/s/AKfycbyxUAY1TjmpZsxrin6BEYIpG6wg4foNim_Ux4xhUHE/dev?page=app&token=c9eb75e4-61b3-4ace-a58c-6a65312a0ad3" class="btn btn-green" target="_blank" data-tags="reports,finance,sales" data-id="revenue-chargeback-report">
        <i class="fas fa-file-excel"></i><span class="btn-text">Radnik GGN BI</span><span class="btn-tag">Reports</span>
      </a>
    </div>
	

    <!-- Recently Accessed Section -->
    <div class="recent-links" id="recentLinksSection">
      <div class="section-header">
        <h2><i class="fas fa-history"></i> Recently Accessed</h2>
        <button class="action-btn-small" id="clearRecentLinksBtn" onclick="clearRecentLinks()"><i class="fas fa-trash-alt"></i> Clear All</button>
      </div>
      <div class="recent-grid" id="recentLinksContainer"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>© 2025 Radnik Exports Global Pvt. Ltd. | Designed & Developed by Amit Chaudhary</p>
      <div class="social-links">
        <a href="#" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="#" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
      </div>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <button id="backToTop" title="Go to top"><i class="fas fa-arrow-up"></i></button>
  
  <!-- Notification Area -->
  <div id="notification"></div>

<script>
    // --- Constants & State Variables ---
    const PORTAL_DATA_VERSION_KEY = 'radnikPortalVersion';
    const CURRENT_PORTAL_VERSION = '1.4.2'; // Updated version
    const USERS_KEY = 'radnikPortalUsers';
    const USER_PERMISSIONS_KEY = 'radnikPortalUserPermissions';
    const GLOBAL_BUTTON_STATES_KEY = 'radnikButtonStates';
    const CUSTOM_LINKS_KEY = 'radnikCustomLinks';
    const RECENT_LINKS_KEY = 'recentLinks';
    const USER_NOTES_KEY = 'userNotes_v2';
    const DASHBOARD_DATA_KEY = 'radnikDashboardData';
    const THEME_SETTINGS_KEY = 'radnikThemeSettings';
    const TASKS_KEY = 'radnikTasks'; // Key for storing tasks
    const PARTICLE_SETTINGS_KEY = 'radnikParticleSettings';

    let currentTaskFilter = 'all'; // To keep track of the active task filter
    let currentTaskSort = 'createdAt'; // To keep track of the active task sort
    let currentTaskView = 'list'; // 'list' or 'board'
    
    const DASHBOARD_SECTION_ID = 'dashboardOverviewSection';
    const RECENT_LINKS_SECTION_ID = 'recentLinksSection';

    let currentUser = null;
    // Randomize particle float direction for variety
    document.documentElement.style.setProperty('--particle-float-x', (Math.random() > 0.5 ? '1000px' : '-1000px'));

    // --- Local Storage Helper Functions ---
    function getFromLocalStorage(key, defaultValue = undefined) {
        const itemJson = localStorage.getItem(key);
        try { 
            return itemJson !== null ? JSON.parse(itemJson) : defaultValue; 
        } catch (e) { 
            console.error(`Error parsing localStorage key "${key}":`, e); 
            return defaultValue; 
        }
    }
    function saveToLocalStorage(key, data) {
        try { 
            localStorage.setItem(key, JSON.stringify(data)); 
        } catch (e) { 
            console.error(`Error saving to localStorage key "${key}":`, e); 
        }
    }
    function getUsers() { return getFromLocalStorage(USERS_KEY, []); }
    function saveUsers(users) { saveToLocalStorage(USERS_KEY, users); }
    function getUserPermissions() { return getFromLocalStorage(USER_PERMISSIONS_KEY, {}); }
    function saveUserPermissions(permissions) { saveToLocalStorage(USER_PERMISSIONS_KEY, permissions); }
    function getGlobalButtonStates() { return getFromLocalStorage(GLOBAL_BUTTON_STATES_KEY, {}); }
    function saveGlobalButtonState(buttonId, isGloballyDisabled) {
        const states = getGlobalButtonStates();
        if (isGloballyDisabled) states[buttonId] = true;
        else delete states[buttonId]; // Remove if not disabled to keep storage clean
        saveToLocalStorage(GLOBAL_BUTTON_STATES_KEY, states);
    }
    function getCustomLinks() { return getFromLocalStorage(CUSTOM_LINKS_KEY, []); }
    function saveCustomLinks(links) { saveToLocalStorage(CUSTOM_LINKS_KEY, links); }

    // Simple password hashing (for demonstration, in production use stronger methods)
    function simpleHash(password) {
        if (typeof password !== 'string') return '';
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
            const char = password.charCodeAt(i);
            hash = ((hash << 5) - hash) + char; // Simple bitwise operation
            hash |= 0; // Convert to 32bit integer
        }
        // Adding some salt and making it look more like a hash for demo purposes
        return `hashed_v3_${Math.abs(hash).toString(16)}_radnik_salt_${password.length}`;
    }

    // --- Initialization & Default Setup ---
    function initializeDefaultAdmin() {
        let users = getUsers();
        const adminUsername = 'admin'; const amitUsername = 'amit';
        const defaultPic = 'https://i.postimg.cc/sXPJH9xd/Screenshot-2025-06-19-143219.png'; // Use the portal logo as default

        const ensureUser = (username, password, profilePicUrl = defaultPic) => {
            let user = users.find(u => u.username === username);
            const passwordHash = simpleHash(password);
            if (!user) {
                users.push({ username, password: passwordHash, profilePicUrl });
                console.log(`Created default user: ${username}`);
                return true; // User was created
            } else {
                let updated = false;
                if (user.password !== passwordHash) {
                    user.password = passwordHash; // Update password if changed
                    updated = true;
                }
                if (user.profilePicUrl !== profilePicUrl) {
                    user.profilePicUrl = profilePicUrl; // Update profile pic if different
                    updated = true;
                }
                if (updated) console.log(`Updated default user: ${username}`);
                return updated; // Return true if user was updated
            }
        };

        // Ensure admin and amit users exist with default credentials
        const adminUpdated = ensureUser(adminUsername, 'aminehu@123', defaultPic); // Admin uses portal logo
        const amitUpdated = ensureUser(amitUsername, 'aminehu@123'); // Amit uses portal logo

        if (adminUpdated || amitUpdated) {
            saveUsers(users); // Save if any user was created or updated
        }
    }

    // --- UI Feedback & Display ---
    function showGeneralMessage(elementId, message, type = 'success') {
        const el = document.getElementById(elementId);
        if (!el) return; // Exit if element doesn't exist
        let iconClass = 'fas fa-check-circle'; messageClass = 'success-message';
        if (type === 'error') { iconClass = 'fas fa-exclamation-triangle'; messageClass = 'error-message'; } 
        else if (type === 'warning') { iconClass = 'fas fa-exclamation-circle'; messageClass = 'warning-message'; }
        el.innerHTML = `<i class="${iconClass}"></i> ${message}`;
        el.className = messageClass; // Set class for styling
        el.style.display = 'flex';
        // Auto-hide messages except warnings
        if (type !== 'warning') { setTimeout(() => { el.style.display = 'none'; }, 3000); }
    }
    function showNotification(message, isError = false, iconClass = null) {
        const el = document.getElementById('notification');
        if (!el) return;
        const icon = iconClass || (isError ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle');
        el.innerHTML = `<i class="${icon}"></i> ${message}`;
        // Set background gradient based on type
        el.style.background = isError ? 'linear-gradient(135deg, var(--accent), #c51162)' : 'linear-gradient(135deg, var(--primary), var(--secondary))';
        el.style.display = 'flex';
        setTimeout(() => { el.style.display = 'none'; }, 3000); // Auto-hide after 3 seconds
    }
    function clearMessage(elementId) { const el = document.getElementById(elementId); if(el) el.style.display = 'none'; }
    
    // Helper to check if current user is admin
    function isUserAdmin() { return currentUser && currentUser.username.toLowerCase() === 'admin'; }

    // --- Authentication Flow ---
    function validateLogin() {
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        const errorMessageEl = document.getElementById('errorMessage');

        clearMessage('errorMessage'); // Clear previous errors
        if (!username || !password) {
            showGeneralMessage('errorMessage', 'Username & Password are required.', 'error');
            return;
        }

        const users = getUsers();
        const passwordHashToCompare = simpleHash(password);
        // Case-insensitive username check
        const foundUser = users.find(user => user.username.toLowerCase() === username.toLowerCase() && user.password === passwordHashToCompare);

        if (foundUser) {
            currentUser = foundUser; // Set current user
            document.getElementById('loginPopup').style.display = 'none'; // Hide login form
            document.querySelector('.container').style.display = 'block'; // Show main content
            document.querySelector('footer').style.display = 'block'; // Show footer
            
            // Update header user profile
            document.getElementById('userProfile').style.display = 'flex';
            document.getElementById('userNameText').textContent = currentUser.username;
            document.getElementById('userProfilePic').src = currentUser.profilePicUrl || 'https://placehold.co/120x120/6a11cb/FFFFFF/png?text=User'; // Default avatar
            
            // Toggle admin-specific UI elements
            document.body.classList.toggle('admin-mode', isUserAdmin());
            document.getElementById('userManagementBtn').style.display = isUserAdmin() ? 'flex' : 'none';
            document.getElementById('portalSettingsBtn').style.display = isUserAdmin() ? 'flex' : 'none';
            document.getElementById('myProfileBtn').style.display = 'flex'; // Show for all logged-in users
            
            if (isUserAdmin()) {
                setupGlobalButtonManagement(); // Enable admin controls for buttons
                loadDashboardData(); // Load dashboard initial data
                renderCustomLinksList(); // Load custom links in settings
                document.getElementById('clearRecentLinksBtn').style.display = 'inline-flex'; // Show clear recent links button
            } else {
                // Remove admin toggles if not admin
                document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove());
                document.getElementById('clearRecentLinksBtn').style.display = 'none';
            }
            
            renderAllButtons(); // Render all buttons (predefined + custom)
            applySectionVisibility(); // Show/hide sections based on admin status
            showWelcomePopup(currentUser.username); // Show welcome message
            
            // Clear login fields after successful login
            usernameInput.value = ''; 
            passwordInput.value = '';
        } else {
            showGeneralMessage('errorMessage', 'Invalid username or password.', 'error');
        }
    }

    // --- Social Login Placeholders ---
    // IMPORTANT: These functions are placeholders. Actual implementation requires OAuth setup.
    function loginWithGoogle() { alert("Google login not implemented yet. Please use username/password or implement OAuth."); }
    function loginWithFacebook() { alert("Facebook login not implemented yet. Please use username/password or implement OAuth."); }
    function loginWithGitHub() { alert("GitHub login not implemented yet. Please use username/password or implement OAuth."); }

    function logout() {
        currentUser = null; // Clear current user session
        document.querySelector('.container').style.display = 'none';
        document.querySelector('footer').style.display = 'none';
        document.getElementById('loginPopup').style.display = 'flex'; // Show login form
        document.getElementById('userProfile').style.display = 'none'; // Hide user profile in header
        document.body.classList.remove('admin-mode'); // Remove admin mode class
        // Hide admin/settings buttons
        document.getElementById('userManagementBtn').style.display = 'none';
        document.getElementById('portalSettingsBtn').style.display = 'none';
        document.getElementById('myProfileBtn').style.display = 'none'; 
        document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove()); // Remove any active toggles
        document.getElementById('clearRecentLinksBtn').style.display = 'none'; // Hide clear recent links
        
        renderAllButtons(); // Re-render buttons (might hide some for logged out state)
        applySectionVisibility(); // Hide sections again
        showNotification('You have been logged out successfully.');
    }
    
    // --- Welcome Popup Animation ---
    function showWelcomePopup(username) {
        const popup = document.getElementById('welcomePopup');
        const messageEl = document.getElementById('welcomeMessage');
        const progressEl = document.getElementById('welcomeProgress');
        if (!popup || !messageEl || !progressEl) return;

        const displayName = username.charAt(0).toUpperCase() + username.slice(1);
        messageEl.innerHTML = `<span>Welcome back, <b>${displayName}</b>!</span>`;
        
        // Reset and restart animation
        progressEl.style.animation = 'none'; 
        popup.offsetHeight; // Trigger reflow
        progressEl.style.animation = 'shrink 5s linear forwards';

        popup.classList.add('show'); // Add class to show it
        
        setTimeout(() => {
            popup.classList.remove('show'); // Remove class to animate out
        }, 5000); // Popup visible for 5 seconds
    }

    // --- User Profile Modal Functions ---
    function openUserProfileModal() {
        if (!currentUser) return; // Ensure user is logged in
        const modal = document.getElementById('userProfileModal');
        clearMessage('userProfileMessage'); // Clear any previous messages
        document.getElementById('profilePicPreview').src = currentUser.profilePicUrl;
        document.getElementById('profilePicUrl').value = currentUser.profilePicUrl;
        document.getElementById('profileNewPassword').value = ''; // Clear password field
        modal.style.display = 'block';
    }
    function closeUserProfileModal() { document.getElementById('userProfileModal').style.display = 'none'; }
    function saveUserProfile() {
        if (!currentUser) return;
        const newPicUrl = document.getElementById('profilePicUrl').value.trim();
        const newPassword = document.getElementById('profileNewPassword').value;

        let users = getUsers();
        const userIndex = users.findIndex(u => u.username === currentUser.username);
        if (userIndex === -1) {
            showGeneralMessage('userProfileMessage', 'Error: User data not found.', 'error');
            return;
        }

        // Update profile picture
        users[userIndex].profilePicUrl = newPicUrl;
        currentUser.profilePicUrl = newPicUrl; // Update in current session too
        document.getElementById('userProfilePic').src = newPicUrl;
        document.getElementById('profilePicPreview').src = newPicUrl;

        // Update password if provided
        if (newPassword) {
            users[userIndex].password = simpleHash(newPassword);
        }

        saveUsers(users); // Save updated user list
        showGeneralMessage('userProfileMessage', 'Profile updated successfully!', 'success');
        document.getElementById('profileNewPassword').value = ''; // Clear password field again
        setTimeout(closeUserProfileModal, 1500); // Close modal after a short delay
    }
    
    // --- Section Visibility Control ---
    function applySectionVisibility() {
        const dashboardSection = document.getElementById(DASHBOARD_SECTION_ID);
        const recentLinksSection = document.getElementById(RECENT_LINKS_SECTION_ID);
        const showAdminSections = isUserAdmin(); // Check if current user is admin

        if (dashboardSection) dashboardSection.style.display = showAdminSections ? 'grid' : 'none';
        if (recentLinksSection) {
            recentLinksSection.style.display = showAdminSections ? 'block' : 'none'; // Show only for admins
            if(showAdminSections) {
                initializeRecentLinks(); // Initialize recent links display
            } else { 
                const recentLinksContainer = document.getElementById('recentLinksContainer');
                if(recentLinksContainer) recentLinksContainer.innerHTML = ''; // Clear if not admin
            }
        } 
    }

    // --- Button Rendering, Visibility & Access Control ---
    // Generates a unique ID for dynamic buttons (custom links)
    function generateButtonId(text) { 
        // Create a somewhat unique ID from text and timestamp
        const safeText = text.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').substring(0, 20);
        return `btn-custom-${safeText}-${Date.now().toString().slice(-5)}`; 
    }

    // Renders all buttons: predefined and custom links
    function renderAllButtons() {
        // Remove any previously added custom buttons before re-rendering
        document.querySelectorAll('#buttonContainer .custom-btn-removable').forEach(btn => btn.remove());

        const customLinks = getCustomLinks(); // Get custom links from storage
        customLinks.forEach(link => {
            const buttonEl = document.createElement('a');
            buttonEl.href = link.url;
            // Use provided color class or default, add custom class for removal and tags
            buttonEl.className = `btn ${link.colorClass || 'btn-info'} custom-btn-removable`; 
            buttonEl.target = '_blank'; 
            buttonEl.dataset.tags = link.tags + ",custom"; // Add 'custom' tag
            buttonEl.dataset.id = link.id; // Assign unique ID
            buttonEl.innerHTML = `<i class="${link.iconClass || 'fas fa-link'}"></i><span class="btn-text">${link.text}</span><span class="btn-tag">${link.tags.split(',')[0]?.trim() || 'Custom'}</span>`; // Display first tag
            document.getElementById('buttonContainer').appendChild(buttonEl);
        });
        
        assignButtonIdsAndTextWrappers(); // Ensure all buttons have IDs and text spans
        if(isUserAdmin()){ setupGlobalButtonManagement(); } // Set up admin toggles if admin
        else { document.querySelectorAll('.admin-toggle').forEach(toggle => toggle.remove()); } // Clean up toggles if not admin
        applyButtonVisibility(); // Apply visibility rules based on admin, permissions, and global states
        setupRecentLinkTracking(); // Set up click listeners for recent links tracking
    }
    
    // Ensures buttons have unique IDs and text spans for better management
    function assignButtonIdsAndTextWrappers() {
        document.querySelectorAll('#buttonContainer .btn').forEach((button, index) => {
            // Assign a unique ID if it doesn't have one
            if (!button.dataset.id) {
                const textSpan = button.querySelector('.btn-text');
                let safeText = `link-${index}`; // Fallback ID
                if (textSpan && textSpan.textContent) {
                    // Generate ID from button text
                    safeText = textSpan.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-');
                }
                button.dataset.id = `btn-hc-${safeText.substring(0,25)}`; // Limit ID length
            }
            // Add a span for button text if missing, to isolate it for potential future styling/handling
            if (!button.querySelector('.btn-text')) {
                const icon = button.querySelector('i:first-child');
                const tag = button.querySelector('.btn-tag');
                let textContent = '';
                // Collect text nodes between icon and tag (or end)
                Array.from(button.childNodes).forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                        textContent += node.textContent.trim() + ' ';
                        button.removeChild(node); // Remove original text node
                    }
                });
                if (textContent.trim()) {
                    const span = document.createElement('span');
                    span.className = 'btn-text';
                    span.textContent = textContent.trim();
                    // Insert span correctly: after icon, before tag, or at end
                    if (icon && icon.nextSibling) button.insertBefore(span, icon.nextSibling);
                    else if (icon) button.appendChild(span);
                    else if (tag) button.insertBefore(span, tag);
                    else button.prepend(span);
                }
            }
        });
    }
    
    // Adds the admin toggle UI element to each button
    function addAdminGlobalToggles() {
        const globalStates = getGlobalButtonStates();
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id;
            // Only add toggle if button has an ID and doesn't already have a toggle
            if (!buttonId || button.querySelector('.admin-toggle')) return;

            const isGloballyDisabled = globalStates[buttonId] === true; // Check if button is disabled globally
            const toggle = document.createElement('span'); // Create the toggle element
            toggle.className = 'admin-toggle';
            toggle.innerHTML = `<i class="fas ${isGloballyDisabled ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>`; // Set initial icon
            toggle.title = "Toggle global link availability"; // Tooltip
            
            // Place toggle before the tag or at the end if no tag
            const btnTag = button.querySelector('.btn-tag'); 
            if(btnTag) button.insertBefore(toggle, btnTag); else button.appendChild(toggle);

            // Add click listener to handle toggle action
            toggle.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent button's default action
                event.stopPropagation(); // Stop event propagation
                
                const currentGlobalState = getGlobalButtonStates()[buttonId] === true; // Get current state
                saveGlobalButtonState(buttonId, !currentGlobalState); // Toggle and save state
                applyButtonVisibility(); // Update button visibility across the UI
                
                const buttonText = button.querySelector('.btn-text').textContent;
                showNotification(`Link "${buttonText}" global state ${!currentGlobalState ? 'DISABLED' : 'ENABLED'}.`, !currentGlobalState); // Show confirmation
            });
        });
    }
    
    // Initializes or re-initializes admin toggles
    function setupGlobalButtonManagement() { addAdminGlobalToggles(); }

    // Applies visibility rules to buttons:
    // - Admins see all, but can toggle global disabled state.
    // - Regular users: Hidden if globally disabled OR not in their permissions list.
    function applyButtonVisibility() {
        const globalStates = getGlobalButtonStates(); // Get all globally disabled button states
        const allUserPerms = getUserPermissions(); // Get all user permission sets
        // Get permissions for the current user, or an empty array if no user or no permissions
        const userPermittedIds = (currentUser && allUserPerms[currentUser.username]) ? allUserPerms[currentUser.username] : [];

        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id; 
            if (!buttonId) { console.warn("Button without data-id found:", button); return; } // Skip if no ID
            
            button.classList.remove('globally-disabled-admin-view'); // Reset admin view class
            button.style.display = 'flex'; // Default to visible for admins

            const isGloballyDisabled = globalStates[buttonId] === true; // Check global state

            if (isUserAdmin()) {
                // Admin always sees the button, visually indicate global disabled state
                button.classList.toggle('globally-disabled-admin-view', isGloballyDisabled);
                const toggleIcon = button.querySelector('.admin-toggle i');
                if (toggleIcon) toggleIcon.className = `fas ${isGloballyDisabled ? 'fa-toggle-on' : 'fa-toggle-off'}`; // Update toggle icon
            } else { 
                // For non-admins, hide button if it's globally disabled OR the user doesn't have permission
                if (isGloballyDisabled || (currentUser && !userPermittedIds.includes(buttonId))) { 
                    button.style.display = 'none'; 
                }
            }
        });
        // Re-apply search and tag filters after visibility changes
        filterBySearchAndTag(); 
    }

    // --- User Management Modal (Admin) ---
    function openUserManagementModal() { 
        if(!isUserAdmin()) return; // Restrict to admin
        const modal = document.getElementById('userManagementModal');
        modal.style.display = 'block';
        populateUsersDropdown(); // Populate the user list
        document.getElementById('permissionsContainer').style.display = 'none'; // Hide permissions initially
        document.getElementById('deleteUserBtn').disabled = true; // Disable delete button initially
        clearMessage('userManagementMessage'); // Clear previous messages
        // Clear input fields
        document.getElementById('newUsername').value = ''; 
        document.getElementById('newPassword').value = ''; 
    }
    function closeUserManagementModal() { document.getElementById('userManagementModal').style.display = 'none'; }
    
    // Creates a new user
    function handleCreateUser() { 
        if(!isUserAdmin()) return;
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        
        // Input validation
        if (!newUsername || !newPassword) { 
            showGeneralMessage('userManagementMessage', 'Username and password are required.', 'error'); 
            return; 
        }
        if (newUsername.toLowerCase() === 'admin') { 
            showGeneralMessage('userManagementMessage', 'Cannot create a user named "admin".', 'error'); 
            return; 
        }
        
        let users = getUsers();
        // Check if username already exists (case-insensitive)
        if (users.some(u => u.username.toLowerCase() === newUsername.toLowerCase())) { 
            showGeneralMessage('userManagementMessage', `User "${newUsername}" already exists.`, 'error'); 
            return; 
        }
        
        // Add new user
        users.push({ username: newUsername, password: simpleHash(newPassword), profilePicUrl: 'https://placehold.co/120x120/6a11cb/FFFFFF/png?text=User' });
        saveUsers(users); // Save updated user list
        showGeneralMessage('userManagementMessage', `User "${newUsername}" created successfully.`, 'success');
        
        // Clear fields and re-populate dropdown
        document.getElementById('newUsername').value = ''; 
        document.getElementById('newPassword').value = ''; 
        populateUsersDropdown(); 
    }
    
    // Populates the user dropdown for permission editing
    function populateUsersDropdown() { 
        if(!isUserAdmin()) return;
        const selectUserEl = document.getElementById('selectUserForPermissions');
        const users = getUsers().filter(u => u.username.toLowerCase() !== 'admin'); // Exclude admin user
        const currentVal = selectUserEl.value; // Store current selection to maintain it if possible
        
        selectUserEl.innerHTML = '<option value="">-- Select User --</option>'; // Reset options
        users.sort((a,b) => a.username.localeCompare(b.username)).forEach(user => { // Sort alphabetically
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = user.username;
            selectUserEl.appendChild(option);
        });
        
        // Try to restore previously selected user if they still exist
        if (users.find(u=>u.username === currentVal)) { 
            selectUserEl.value = currentVal; 
            loadPermissionsForSelectedUser(); // Reload permissions for the restored user
        } else { 
            document.getElementById('permissionsContainer').style.display = 'none'; 
            document.getElementById('deleteUserBtn').disabled = true; 
        }
    }
    
    // Loads permissions for the selected user into the UI
    function loadPermissionsForSelectedUser() { 
        if(!isUserAdmin()) return;
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        const permissionsContainer = document.getElementById('permissionsContainer');
        const permissionsListDiv = document.getElementById('permissionsList');
        const deleteBtn = document.getElementById('deleteUserBtn');
        
        clearMessage('userManagementMessage'); // Clear messages
        
        if (!selectedUsername) { // If no user is selected
            permissionsContainer.style.display = 'none'; 
            deleteBtn.disabled = true; 
            return; 
        }
        
        deleteBtn.disabled = false; // Enable delete button
        permissionsContainer.style.display = 'block'; // Show the permissions area
        permissionsListDiv.innerHTML = ''; // Clear previous permission items
        
        const allUserPerms = getUserPermissions();
        const userSpecificPerms = allUserPerms[selectedUsername] || []; // Get user's current permissions
        
        // Iterate through all buttons to create permission checkboxes
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const buttonId = button.dataset.id; 
            const btnTextSpan = button.querySelector('.btn-text');
            const buttonText = btnTextSpan ? btnTextSpan.textContent.trim() : `Button (ID: ${buttonId})`;
            
            if (!buttonId) return; // Skip buttons without IDs
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'permission-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `perm-${buttonId}-${selectedUsername}`; // Unique ID for label association
            checkbox.value = buttonId;
            checkbox.checked = userSpecificPerms.includes(buttonId); // Check if user has permission
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = buttonText;
            
            const icon = button.querySelector('i:first-child'); // Get the button's icon
            if(icon) { 
                const iClone = icon.cloneNode(true); // Clone the icon
                itemDiv.appendChild(iClone); // Add icon to the permission item
            }
            itemDiv.appendChild(checkbox); // Add checkbox
            itemDiv.appendChild(label); // Add label
            permissionsListDiv.appendChild(itemDiv); // Add the complete item to the list
        });
    }
    
    // Saves the selected permissions for the current user
    function handleSavePermissions() { 
        if(!isUserAdmin()) return;
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        
        if (!selectedUsername) { 
            showGeneralMessage('userManagementMessage', 'Please select a user first.', 'error'); 
            return; 
        }
        
        // Get all checked checkboxes (allowed button IDs)
        const allowedButtonIds = Array.from(document.querySelectorAll('#permissionsList input[type="checkbox"]:checked'))
                                       .map(cb => cb.value);
        
        let allUserPerms = getUserPermissions();
        allUserPerms[selectedUsername] = allowedButtonIds; // Assign permissions
        saveUserPermissions(allUserPerms); // Save to storage
        
        showGeneralMessage('userManagementMessage', `Permissions saved for ${selectedUsername}.`, 'success');
        
        // If the current logged-in user's permissions were changed, re-render buttons
        if (currentUser && currentUser.username === selectedUsername) {
            renderAllButtons(); 
        }
    }
    
    // Deletes the selected user
    function handleDeleteUser() { 
        if(!isUserAdmin()) return;
        const selectedUsername = document.getElementById('selectUserForPermissions').value;
        
        // Prevent deleting admin or if no user selected
        if (!selectedUsername || selectedUsername.toLowerCase() === 'admin') { 
            showGeneralMessage('userManagementMessage','Select a valid user to delete.', 'error'); 
            return; 
        }
        
        // Confirmation dialog
        if (!confirm(`Are you sure you want to delete user "${selectedUsername}"? This action cannot be undone.`)) return;
        
        let users = getUsers();
        // Filter out the user to be deleted
        saveUsers(users.filter(u => u.username !== selectedUsername)); 
        
        let permissions = getUserPermissions();
        delete permissions[selectedUsername]; // Remove user's permissions entry
        saveUserPermissions(permissions); // Save updated permissions
        
        showGeneralMessage('userManagementMessage', `User "${selectedUsername}" deleted successfully.`, 'success');
        
        // Refresh the user dropdown and reset permissions view
        populateUsersDropdown(); 
    }
    
    // --- Dashboard Data Management (Admin Only) ---
    // Default data for the dashboard overview cards
    const defaultDashboardData = { 
      ggnSaleQty: { value: "361,823", unit: "pcs", updated: new Date().toISOString() }, 
      ggnSaleValue: { value: "54.46", unit: "Cr", updated: new Date().toISOString() }, 
      noidaSaleQty: { value: "54,600", unit: "pcs", updated: new Date().toISOString() }, 
      noidaSaleValue: { value: "6.40", unit: "Cr", updated: new Date().toISOString() } 
    };
    
    // Loads and displays dashboard data from local storage
    function loadDashboardData() { 
        if (!isUserAdmin()) return;
        const storedData = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        // Merge stored data with defaults to ensure all cards are present
        const mergedData = { ...defaultDashboardData, ...storedData }; 
        Object.keys(mergedData).forEach(cardId => {
            const cardElement = document.querySelector(`.overview-card[data-card-id="${cardId}"]`);
            if (cardElement) {
                cardElement.querySelector('.card-value').textContent = mergedData[cardId].value;
                cardElement.querySelector('.card-unit').textContent = mergedData[cardId].unit || "";
                cardElement.querySelector('.card-update-time').textContent = formatTime(mergedData[cardId].updated);
            }
        });
        // Save merged data back in case defaults were used for new keys
        if (JSON.stringify(storedData) !== JSON.stringify(mergedData)) {
            saveToLocalStorage(DASHBOARD_DATA_KEY, mergedData);
        }
    }
    
    // Opens the modal to edit a specific dashboard card's data
    function openEditDashboardModal(cardId) { 
        if (!isUserAdmin()) return; 
        clearMessage('editDashboardMessage'); 
        const data = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        const cardData = data[cardId];
        
        if (!cardData) { // Handle case where card data is missing
            showGeneralMessage('editDashboardMessage', `Data for card ID "${cardId}" not found.`, 'error'); 
            return; 
        }
        
        document.getElementById('editingCardId').value = cardId; // Store the ID of the card being edited
        document.getElementById('cardValueInput').value = cardData.value;
        document.getElementById('cardUnitInput').value = cardData.unit || "";
        document.getElementById('editDashboardModal').style.display = 'block';
        document.getElementById('cardValueInput').focus(); // Focus the value input
    }
    function closeEditDashboardModal() { document.getElementById('editDashboardModal').style.display = 'none'; }
    
    // Saves the edited dashboard data
    function handleSaveDashboardData() { 
        if (!isUserAdmin()) return;
        const cardId = document.getElementById('editingCardId').value;
        const newValue = document.getElementById('cardValueInput').value.trim();
        const newUnit = document.getElementById('cardUnitInput').value.trim();
        
        if (!newValue) { // Value is required
            showGeneralMessage('editDashboardMessage', 'Value cannot be empty.', 'error'); 
            return; 
        }
        
        let data = getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData);
        if (data[cardId]) {
            data[cardId].value = newValue;
            data[cardId].unit = newUnit;
            data[cardId].updated = new Date().toISOString(); // Update timestamp
            saveToLocalStorage(DASHBOARD_DATA_KEY, data); // Save changes
            loadDashboardData(); // Refresh displayed data
            showGeneralMessage('editDashboardMessage', 'Dashboard data updated successfully!', 'success');
            setTimeout(closeEditDashboardModal, 1500); // Close modal after success
        } else { // Error if card ID is somehow invalid
            showGeneralMessage('editDashboardMessage', 'Error: Card ID not found.', 'error'); 
        }
    }

    // --- Portal Settings Modal Functions ---
    function openPortalSettingsModal() { 
        if (!isUserAdmin()) return; 
        clearMessage('portalSettingsMessage'); 
        // Load current theme settings into pickers
        document.getElementById('primaryColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        document.getElementById('accentColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        // Load particle setting into checkbox
        document.getElementById('particleToggle').checked = !document.getElementById('particles').classList.contains('hidden');
        renderCustomLinksList(); // Populate the custom links list
        resetCustomLinkForm(); // Reset the form for adding/editing links
        document.getElementById('portalSettingsModal').style.display = 'block'; 
    }
    function closePortalSettingsModal() { document.getElementById('portalSettingsModal').style.display = 'none'; }
    
    // Loads and applies theme settings from local storage
    function loadThemeSettings() { 
        const settings = getFromLocalStorage(THEME_SETTINGS_KEY, {});
        const rootStyle = document.documentElement.style;
        const defaultPrimary = '#5A00C9'; // Deeper purple fallback
        const defaultAccent = '#E11D48'; // Vibrant accent fallback
        
        // Apply stored or default colors to CSS variables
        rootStyle.setProperty('--primary', settings.primary || defaultPrimary);
        rootStyle.setProperty('--accent', settings.accent || defaultAccent);
        
        // Update color picker values to match applied styles
        const primaryPicker = document.getElementById('primaryColorPicker');
        const accentPicker = document.getElementById('accentColorPicker');
        if (primaryPicker) primaryPicker.value = settings.primary || defaultPrimary;
        if (accentPicker) accentPicker.value = settings.accent || defaultAccent;
    }
    
    // Saves theme settings
    function saveThemeSettings() { 
        if (!isUserAdmin()) return;
        const primaryColor = document.getElementById('primaryColorPicker').value;
        const accentColor = document.getElementById('accentColorPicker').value;
        
        // Apply colors immediately
        document.documentElement.style.setProperty('--primary', primaryColor);
        document.documentElement.style.setProperty('--accent', accentColor);
        
        // Save to local storage
        saveToLocalStorage(THEME_SETTINGS_KEY, { primary: primaryColor, accent: accentColor });
        showGeneralMessage('portalSettingsMessage', 'Theme colors updated!', 'success');
    }
    
    // Resets theme and particle settings to default
    function resetDefaultThemeAndParticles() { 
        if (!isUserAdmin()) return;
        if (!confirm("Are you sure you want to reset theme colors and particle settings to default?")) return;
        
        // Remove settings from local storage
        localStorage.removeItem(THEME_SETTINGS_KEY); 
        localStorage.removeItem(PARTICLE_SETTINGS_KEY);
        
        // Re-apply defaults
        loadThemeSettings(); 
        loadParticleSetting(); 
        
        // Update picker and checkbox values
        document.getElementById('primaryColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        document.getElementById('accentColorPicker').value = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
        document.getElementById('particleToggle').checked = !document.getElementById('particles').classList.contains('hidden');
        
        showGeneralMessage('portalSettingsMessage', 'Visuals reset to default.', 'success');
    }
    
    // Loads and applies particle background setting
    function loadParticleSetting() { 
        const enabled = getFromLocalStorage(PARTICLE_SETTINGS_KEY, true); // Default to enabled
        const particleDiv = document.getElementById('particles');
        if (particleDiv) {
            particleDiv.classList.toggle('hidden', !enabled); // Toggle visibility class
            if(enabled && particleDiv.innerHTML === '') { // If enabled and particles not yet created
                createParticles(); // Generate particles
            } else if (!enabled) { 
                particleDiv.innerHTML = ''; // Clear particles if disabled
            }
        }
    }
    
    // Toggles particle background via checkbox
    function toggleParticles() { 
        if (!isUserAdmin()) return;
        const enabled = document.getElementById('particleToggle').checked;
        saveToLocalStorage(PARTICLE_SETTINGS_KEY, enabled); // Save setting
        loadParticleSetting(); // Apply setting
        showGeneralMessage('portalSettingsMessage', `Particles ${enabled ? 'enabled' : 'disabled'}.`, 'success');
    }
    
    // Renders the list of custom links in the settings modal
    function renderCustomLinksList() { 
        if (!isUserAdmin()) return;
        const listEl = document.getElementById('customLinksList');
        listEl.innerHTML = ''; // Clear existing list items
        const links = getCustomLinks();
        
        if (links.length === 0) { // Display message if no links
            listEl.innerHTML = '<li><span class="link-details">No custom links defined yet.</span></li>';
            return;
        }
        
        // Create list items for each custom link
        links.forEach(link => { 
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="link-details">
                    <span class="link-title"><i class="${link.iconClass || 'fas fa-link'}"></i> ${link.text}</span>
                    <span class="link-url">${link.url}</span>
                </div>
                <div class="link-actions">
                    <button class="view-btn" onclick="window.open('${link.url}', '_blank')" title="View Link"><i class="fas fa-external-link-alt"></i></button>
                    <button class="edit-btn" onclick="editCustomLink('${link.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="delete-btn" onclick="deleteCustomLink('${link.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }
    
    // Resets the custom link form fields
    function resetCustomLinkForm() { 
        document.getElementById('editingCustomLinkId').value = ''; 
        document.getElementById('customLinkText').value = ''; 
        document.getElementById('customLinkUrl').value = ''; 
        document.getElementById('customLinkIcon').value = 'fas fa-link'; // Default icon
        document.getElementById('customLinkColorClass').value = 'btn-info'; // Default color class
        document.getElementById('customLinkTags').value = ''; 
        document.getElementById('addOrUpdateCustomLinkBtn').innerHTML = '<i class="fas fa-plus-circle"></i> Add Link'; // Reset button text
    }
    
    // Adds or updates a custom link
    function handleAddOrUpdateCustomLink() { 
        if (!isUserAdmin()) return;
        const id = document.getElementById('editingCustomLinkId').value;
        const text = document.getElementById('customLinkText').value.trim();
        const url = document.getElementById('customLinkUrl').value.trim();
        const iconClass = document.getElementById('customLinkIcon').value.trim() || 'fas fa-link'; // Default icon
        const colorClass = document.getElementById('customLinkColorClass').value.trim() || 'btn-info'; // Default color class
        const tags = document.getElementById('customLinkTags').value.trim(); 
        
        // Basic validation
        if (!text || !url) { 
            showGeneralMessage('portalSettingsMessage', 'Link Text and URL are required.', 'error'); 
            return; 
        }
        // URL format validation
        try { new URL(url); } catch (_) { 
            showGeneralMessage('portalSettingsMessage', 'Invalid URL format.', 'error'); 
            return; 
        }
        
        let links = getCustomLinks();
        if (id) { // If editing an existing link
            const linkIndex = links.findIndex(l => l.id === id);
            if (linkIndex > -1) {
                // Update the existing link object
                links[linkIndex] = { ...links[linkIndex], text, url, iconClass, colorClass, tags }; 
            }
        } else { // If adding a new link
            links.push({ id: generateButtonId(text), text, url, iconClass, colorClass, tags });
        }
        
        saveCustomLinks(links); // Save the updated list
        renderCustomLinksList(); // Refresh the list display
        renderAllButtons(); // Re-render all buttons to include the new/updated custom link
        resetCustomLinkForm(); // Clear the form
        showGeneralMessage('portalSettingsMessage', `Custom link ${id ? 'updated' : 'added'} successfully.`, 'success');
    }
    
    // Populates the form with data for editing a custom link
    function editCustomLink(id) { 
        if (!isUserAdmin()) return;
        const links = getCustomLinks();
        const link = links.find(l => l.id === id); // Find the link by ID
        
        if (link) {
            // Fill form fields
            document.getElementById('editingCustomLinkId').value = link.id;
            document.getElementById('customLinkText').value = link.text;
            document.getElementById('customLinkUrl').value = link.url;
            document.getElementById('customLinkIcon').value = link.iconClass;
            document.getElementById('customLinkColorClass').value = link.colorClass;
            document.getElementById('customLinkTags').value = link.tags;
            // Change button text to 'Update'
            document.getElementById('addOrUpdateCustomLinkBtn').innerHTML = '<i class="fas fa-save"></i> Update Link';
            document.getElementById('customLinkText').focus(); // Focus the first field
        }
    }
    
    // Deletes a custom link
    function deleteCustomLink(id) { 
        if (!isUserAdmin()) return;
        if (!confirm('Are you sure you want to delete this custom link?')) return; // Confirmation
        
        let links = getCustomLinks();
        links = links.filter(l => l.id !== id); // Remove the link
        saveCustomLinks(links); // Save updated list
        renderCustomLinksList(); // Refresh list
        renderAllButtons(); // Re-render buttons to remove it
        resetCustomLinkForm(); // Reset form
        showGeneralMessage('portalSettingsMessage', 'Custom link deleted.', 'success');
    }
    
    // Exports portal configuration (users, links, settings) as a JSON file
    function exportPortalConfig() { 
        if (!isUserAdmin()) return;
        const config = { 
            version: CURRENT_PORTAL_VERSION,
            users: getUsers(), 
            permissions: getUserPermissions(), 
            globalButtonStates: getGlobalButtonStates(), 
            customLinks: getCustomLinks(), 
            dashboardData: getFromLocalStorage(DASHBOARD_DATA_KEY, defaultDashboardData), 
            themeSettings: getFromLocalStorage(THEME_SETTINGS_KEY, {}), 
            particleSettings: getFromLocalStorage(PARTICLE_SETTINGS_KEY, true) 
        };
        
        // Create a Blob and trigger download
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g,""); // Format timestamp YYYYMMDDTHHMMSS
        a.href = url;
        a.download = `radnik_portal_config_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); // Clean up object URL
        showGeneralMessage('portalSettingsMessage', 'Configuration exported.', 'success');
    }
    
    // Imports portal configuration from a JSON file
    function handleImportConfig(event) { 
        if (!isUserAdmin()) return;
        const file = event.target.files[0];
        if (!file) return; // Exit if no file selected
        
        // Confirmation before overwriting
        if (!confirm("Importing this configuration will overwrite all current portal settings (users, links, themes, etc.). Are you sure?")) { 
            event.target.value = null; // Clear file input
            return; 
        }
        
        const reader = new FileReader();
        reader.onload = (e) => { // On file read success
            try { 
                const config = JSON.parse(e.target.result);
                // Basic validation of file structure
                if (!config.version || typeof config.users === 'undefined' || typeof config.permissions === 'undefined') { 
                    throw new Error("Invalid or incomplete configuration file structure."); 
                }
                
                // Restore settings from the imported config
                saveUsers(config.users || []); 
                saveUserPermissions(config.permissions || {}); 
                saveToLocalStorage(GLOBAL_BUTTON_STATES_KEY, config.globalButtonStates || {}); 
                saveCustomLinks(config.customLinks || []); 
                saveToLocalStorage(DASHBOARD_DATA_KEY, config.dashboardData || defaultDashboardData); 
                saveToLocalStorage(THEME_SETTINGS_KEY, config.themeSettings || {}); 
                saveToLocalStorage(PARTICLE_SETTINGS_KEY, typeof config.particleSettings !== 'undefined' ? config.particleSettings : true); 
                
                showGeneralMessage('portalSettingsMessage', 'Configuration imported successfully! Reloading page...', 'success');
                // Reload page to apply all changes
                setTimeout(() => window.location.reload(), 2000); 
            } catch (error) { 
                console.error("Error importing configuration:", error); 
                showGeneralMessage('portalSettingsMessage', `Import failed: ${error.message}`, 'error'); 
            } finally { 
                event.target.value = null; // Clear file input regardless of success/failure
            } 
        };
        reader.readAsText(file); // Read the file as text
    }
    
    // Clears ALL portal data from local storage (dangerous operation)
    function clearAllPortalData() { 
        if (!isUserAdmin()) return;
        // Multiple confirmations for safety
        if (!confirm("DANGER: This will delete ALL portal data from your browser's local storage (users, links, settings, etc.). This action cannot be undone. Are you absolutely sure?")) return;
        if (!confirm("SECOND CONFIRMATION: Are you 100% certain you want to erase everything?")) return;
        
        // List of all keys used by the portal
        const keysToClear = [ 
            PORTAL_DATA_VERSION_KEY, USERS_KEY, USER_PERMISSIONS_KEY, 
            GLOBAL_BUTTON_STATES_KEY, CUSTOM_LINKS_KEY, RECENT_LINKS_KEY, 
            USER_NOTES_KEY, DASHBOARD_DATA_KEY, THEME_SETTINGS_KEY, 
            PARTICLE_SETTINGS_KEY 
        ];
        // Remove each key from local storage
        keysToClear.forEach(key => localStorage.removeItem(key)); 
        
        showGeneralMessage('portalSettingsMessage', 'All portal data cleared. Logging out...', 'warning');
        // Log out and reload the page after a short delay
        setTimeout(() => { 
            currentUser = null; 
            window.location.reload(); 
        }, 2500); 
    }

    // --- Task Manager Functions ---
    function getTasks() { return getFromLocalStorage(TASKS_KEY, []); }
    function saveTasks(tasks) { saveToLocalStorage(TASKS_KEY, tasks); }

    function openTaskManagerModal() {
        const modal = document.getElementById('taskManagerModal');
        if (modal) {
            switchTaskView('list'); // Default to list view
            currentTaskFilter = 'all'; // Reset filter to 'all'
            currentTaskSort = 'createdAt'; // Reset sort
            populateTaskCategoriesDatalist();
            modal.style.display = 'block';
            populateTaskAssigneeDropdown();
            renderCurrentTaskView();
            resetTaskForm();
        }
    }

    function closeTaskManagerModal() {
        document.getElementById('taskManagerModal').style.display = 'none';
    }

    function populateTaskAssigneeDropdown() {
        const selectEl = document.getElementById('taskAssignee');
        const users = getUsers();
        selectEl.innerHTML = '<option value="">-- Assign to User --</option>'; // Reset
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.username;
            option.textContent = user.username;
            selectEl.appendChild(option);
        });
    }

    function populateTaskCategoriesDatalist() {
        const datalistEl = document.getElementById('taskCategoriesDatalist');
        const tasks = getTasks();
        const categories = [...new Set(tasks.map(task => task.category).filter(Boolean))]; // Get unique, non-empty categories
        datalistEl.innerHTML = '';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            datalistEl.appendChild(option);
        });
    }

    function renderTaskCategoryFilters() {
        const filtersEl = document.getElementById('taskFilters');
        const tasks = getTasks();
        const categories = [...new Set(tasks.map(task => task.category).filter(Boolean))]; // Unique, non-empty categories
        
        filtersEl.innerHTML = `<div class="task-filter-btn ${currentTaskFilter === 'all' ? 'active' : ''}" onclick="setTaskFilter('all')">All</div>`;
        
        categories.sort().forEach(category => {
            filtersEl.innerHTML += `<div class="task-filter-btn ${currentTaskFilter === category ? 'active' : ''}" onclick="setTaskFilter('${category}')">${category}</div>`;
        });
    }

    function setTaskFilter(category) {
        currentTaskFilter = category;
        renderTasks();
    }

    function handleTaskSortChange(sortValue) {
        currentTaskSort = sortValue;
        renderTasks();
    }

    function switchTaskView(view) {
        currentTaskView = view;
        document.getElementById('taskListView').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('taskBoardView').style.display = view === 'board' ? 'grid' : 'none';
        document.getElementById('taskViewListBtn').classList.toggle('active', view === 'list');
        document.getElementById('taskViewBoardBtn').classList.toggle('active', view === 'board');
        renderCurrentTaskView();
    }

    function renderCurrentTaskView() {
        if (currentTaskView === 'list') {
            renderTaskListView();
        } else {
            renderTaskBoardView();
        }
    }

    function getProcessedTasks() {
        renderTaskCategoryFilters(); // Update filters every time tasks are rendered
        let tasks = getTasks();

        // 1. Search
        const searchInput = document.getElementById('taskSearchInput');
        // Ensure searchInput exists before accessing its value
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        let processedTasks = searchTerm
            ? tasks.filter(t => t.title.toLowerCase().includes(searchTerm) || t.description.toLowerCase().includes(searchTerm))
            : tasks;

        // 2. Filter by Category
        processedTasks = currentTaskFilter === 'all' 
            ? processedTasks 
            : processedTasks.filter(task => task.category === currentTaskFilter);

        // 3. Sort
        const priorityOrder = { 'low': 1, 'medium': 2, 'high': 3, 'urgent': 4 };
        processedTasks.sort((a, b) => {
            if (currentTaskSort === 'dueDate') {
                if (!a.dueDate) return 1; if (!b.dueDate) return -1;
                return new Date(a.dueDate) - new Date(b.dueDate);
            }
            if (currentTaskSort === 'priority') {
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            }
            // Default: createdAt
            return new Date(b.createdAt) - new Date(a.createdAt);
        });

        // Update Summary
        const totalTasks = processedTasks.length;
        const completedTasks = processedTasks.filter(t => t.status === 'completed').length;
        const summaryEl = document.getElementById('taskSummary');
        if (summaryEl) {
            summaryEl.innerHTML = `<span>${completedTasks} / ${totalTasks} Completed</span><div class="progress-bar"><div class="progress-bar-inner" style="width: ${totalTasks > 0 ? (completedTasks/totalTasks)*100 : 0}%"></div></div>`;
        }
        
        return processedTasks;
    }

    function renderTaskListView() {
        const taskListEl = document.getElementById('taskListView');
        const taskEmptyStateEl = document.querySelector('.task-view-container').querySelector('#taskEmptyState');
        if (!taskEmptyStateEl) { // Create if not exists
            const emptyState = document.createElement('div');
            emptyState.id = 'taskEmptyState';
            emptyState.innerHTML = `<i class="fas fa-check-double"></i><h4>All Clear!</h4><p></p>`;
            document.querySelector('.task-view-container').appendChild(emptyState);
        }
        taskListEl.innerHTML = '';
        const processedTasks = getProcessedTasks();

        if (processedTasks.length === 0) {
            taskListEl.style.display = 'none';
            taskEmptyStateEl.style.display = 'block';
            taskEmptyStateEl.querySelector('p').textContent = getTasks().length === 0 ? "You have no tasks. Create one to get started!" : "No tasks match the current filters.";
            return;
        } else {
            taskListEl.style.display = 'block';
            taskEmptyStateEl.style.display = 'none';
        }

        processedTasks.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = 'task-item';
            if (task.status === 'completed') taskEl.classList.add('completed');
            
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'completed';
            if (isOverdue) taskEl.classList.add('overdue');

            taskEl.innerHTML = `
                <div class="task-header">
                    <span class="task-title">${task.title}</span>
                    <span class="priority-badge priority-${task.priority || 'low'}">${task.priority || 'low'}</span>
                </div>
                <div class="task-meta-container">
                    <div class="task-meta-item"><i class="fas fa-user-check"></i><span>${task.assignee || 'Unassigned'}</span></div>
                    <div class="task-meta-item"><i class="fas fa-calendar-alt"></i><span>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date'}</span></div>
                    <div class="task-meta-item"><i class="fas fa-tag"></i><span>${task.category || 'General'}</span></div>
                </div>
                <p class="task-description">${task.description || '<i>No description provided.</i>'}</p>
                <div class="task-actions">
                    <button class="complete-btn" onclick="handleToggleTaskStatus('${task.id}', task.status === 'pending' ? 'completed' : 'pending')"><i class="fas fa-check"></i> ${task.status === 'completed' ? 'Mark Pending' : 'Complete'}</button>
                    <button class="edit-btn" onclick="editTask('${task.id}')"><i class="fas fa-edit"></i> Edit</button>
                    <button class="delete-btn" onclick="handleDeleteTask('${task.id}')"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
            taskListEl.appendChild(taskEl);
        });
    }

    function renderTaskBoardView() {
        const boardEl = document.getElementById('taskBoardView');
        const taskEmptyStateEl = document.querySelector('.task-view-container').querySelector('#taskEmptyState');
        boardEl.innerHTML = ''; // Clear board
        const processedTasks = getProcessedTasks();

        if (processedTasks.length === 0) {
            boardEl.style.display = 'none';
            taskEmptyStateEl.style.display = 'block';
            taskEmptyStateEl.querySelector('p').textContent = getTasks().length === 0 ? "You have no tasks. Create one to get started!" : "No tasks match the current filters.";
            return;
        } else {
            boardEl.style.display = 'grid';
            taskEmptyStateEl.style.display = 'none';
        }

        const statuses = ['pending', 'completed'];
        const users = getUsers();

        statuses.forEach(status => {
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.status = status;
            column.innerHTML = `<div class="kanban-column-header">${status.charAt(0).toUpperCase() + status.slice(1)}</div><div class="kanban-cards"></div>`;
            boardEl.appendChild(column);

            column.addEventListener('dragover', e => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
            column.addEventListener('drop', e => {
                e.preventDefault();
                column.classList.remove('drag-over');
                const taskId = e.dataTransfer.getData('text/plain');
                const newStatus = column.dataset.status;
                handleToggleTaskStatus(taskId, newStatus);
            });
        });

        processedTasks.forEach(task => {
            const column = boardEl.querySelector(`.kanban-column[data-status="${task.status}"] .kanban-cards`);
            if (column) {
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.dataset.taskId = task.id;
                card.dataset.priority = task.priority || 'low';
                card.draggable = true;
                
                const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'completed';
                if (isOverdue) card.classList.add('overdue');

                const assignee = users.find(u => u.username === task.assignee);
                const assigneeAvatar = assignee ? `<img src="${assignee.profilePicUrl}" alt="${assignee.username}" title="${assignee.username}">` : '<i class="fas fa-user-slash"></i>';

                card.innerHTML = `
                    <div class="kanban-card-title">${task.title}</div>
                    <div class="kanban-card-meta">
                        <span class="kanban-card-assignee">${assigneeAvatar} ${task.assignee || 'N/A'}</span>
                        <span><i class="far fa-calendar-alt"></i> ${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'N/A'}</span>
                    </div>
                `;
                card.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', task.id);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.ondblclick = () => editTask(task.id);

                column.appendChild(card);
            }
        });
    }

    function handleSaveTask() {
        const id = document.getElementById('editingTaskId').value;
        const title = document.getElementById('taskTitle').value.trim();
        if (!title) {
            showGeneralMessage('taskManagerMessage', 'Task title is required.', 'error');
            return;
        }

        let tasks = getTasks();
        const taskData = {
            title,
            description: document.getElementById('taskDescription').value.trim(),
            dueDate: document.getElementById('taskDueDate').value,
            assignee: document.getElementById('taskAssignee').value,
            priority: document.getElementById('taskPriority').value,
            category: document.getElementById('taskCategory').value.trim() || 'General', // Default category
        };

        if (id) { // Update existing task
            const taskIndex = tasks.findIndex(t => t.id === id);
            if (taskIndex > -1) {
                tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
            }
        } else { // Create new task
            taskData.id = `task-${Date.now()}`;
            taskData.createdAt = new Date().toISOString();
            taskData.status = 'pending';
            tasks.push(taskData);
        }

        saveTasks(tasks);
        renderCurrentTaskView();
        populateTaskCategoriesDatalist(); // Update datalist with new category if any
        resetTaskForm();
        showGeneralMessage('taskManagerMessage', `Task ${id ? 'updated' : 'created'} successfully.`, 'success');
    }

    function resetTaskForm() {
        document.getElementById('editingTaskId').value = '';
        document.getElementById('taskFormTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Create New Task';
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskDueDate').value = '';
        document.getElementById('taskAssignee').value = '';
        document.getElementById('taskPriority').value = 'medium';
        document.getElementById('taskCategory').value = '';
        document.getElementById('cancelEditTaskBtn').style.display = 'none';
        document.getElementById('taskTitle').focus();
    }

    function editTask(id) {
        const tasks = getTasks();
        const task = tasks.find(t => t.id === id);
        if (task) {
            document.getElementById('editingTaskId').value = task.id;
            document.getElementById('taskFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Task';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskDueDate').value = task.dueDate;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskCategory').value = task.category;
            document.getElementById('cancelEditTaskBtn').style.display = 'inline-block';
            document.getElementById('taskTitle').focus();
        }
    }

    function handleDeleteTask(id) {
        if (confirm('Are you sure you want to delete this task?')) {
            let tasks = getTasks();
            tasks = tasks.filter(t => t.id !== id);
            saveTasks(tasks);
            renderCurrentTaskView();
            showGeneralMessage('taskManagerMessage', 'Task deleted.', 'success');
        }
    }

    function handleToggleTaskStatus(id, newStatus) {
        let tasks = getTasks();
        const taskIndex = tasks.findIndex(t => t.id === id);
        if (taskIndex > -1) {
            const task = tasks[taskIndex];
            const oldStatus = task.status;
            task.status = newStatus;
            
            if (task.status === 'completed' && oldStatus !== 'completed') {
                showNotification(`Task "${task.title}" completed!`, false, 'fas fa-check-double');
                // Open mail client with pre-filled details
                const subject = encodeURIComponent(`Task Completed: ${task.title}`);
                const body = encodeURIComponent(`Hello,\n\nThe task "${task.title}" assigned to ${task.assignee || 'a user'} has been marked as complete.\n\nDue Date: ${task.dueDate || 'N/A'}\n\nThank you.`);
                // You can add a recipient email here, e.g., `mailto:test@example.com?subject=...`
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }

            saveTasks(tasks);
            renderCurrentTaskView();
        }
    }

    // --- General Feature Functions ---
    

    // Creates particle elements for the background effect
    function createParticles() { 
        const container = document.getElementById('particles');
        if (!container || container.classList.contains('hidden')) return; // Don't create if container is hidden or missing
        container.innerHTML = ''; // Clear existing particles
        
        // Adjust particle count based on window width for better performance/density
        const count = Math.floor(window.innerWidth / 25); // More particles for denser effect
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.classList.add('particle');
            
            // Randomize particle size, position, opacity, and animation duration
            const size = Math.random() * 4 + 1; // Slightly larger particles
            p.style.width = `${size}px`;
            p.style.height = `${size}px`;
            p.style.left = `${Math.random() * window.innerWidth}px`;
            // Start particles from below the visible screen to simulate upward float
            p.style.top = `${Math.random() * (window.innerHeight + 500)}px`; // Start even lower
            p.style.opacity = Math.random() * 0.3 + 0.1; // Faint particles
            p.style.animationDuration = `${Math.random() * 25 + 15}s`; // Slower, drifting animation
            p.style.animationDelay = `${Math.random() * 25}s`; // Stagger animation start
            
            container.appendChild(p);
        } 
    }
    
    // Opens the notepad modal
    function openNotepadModal() { 
        const modal = document.getElementById('notepadModal');
        if (modal) {
            modal.style.display = 'block';
            const textarea = document.getElementById('notepadTextarea');
            textarea.value = getFromLocalStorage(USER_NOTES_KEY, ''); // Load notes from storage
            textarea.focus(); // Focus textarea for immediate typing
        }
    }
    function closeNotepadModal() { document.getElementById('notepadModal').style.display = 'none'; }
    
    // Saves notes from the notepad to local storage
    function saveNotepadContent() { 
        saveToLocalStorage(USER_NOTES_KEY, document.getElementById('notepadTextarea').value);
        showNotification('Notes saved to local storage!', false, 'fas fa-save'); // Show success notification
    }
    
    // Updates the clock display in the header
    function updateClock() { 
        const clockEl = document.getElementById('clock');
        if (clockEl) { 
            const now = new Date();
            // Format date and time nicely
            clockEl.innerHTML = `<i class="far fa-calendar-alt"></i> ${now.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })} | ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
        }
    }
    
    // Filters buttons based on search input and active tag filter
    function filterBySearchAndTag() { 
        const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
        // Get the currently active filter tag
        const activeFilter = document.querySelector('.filter-tag.active')?.dataset.filter || 'all'; 
        
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            const isVisibleByPerms = button.style.display !== 'none'; // Check if button is already hidden due to permissions
            
            // Only proceed if the button is visible (or if user is admin who sees all initially)
            if (isUserAdmin() || isVisibleByPerms) { 
                const btnText = (button.querySelector('.btn-text')?.textContent || '').toLowerCase();
                const btnTags = button.dataset.tags || '';
                
                // Check if button matches search term
                const matchesSearch = !searchTerm || btnText.includes(searchTerm);
                // Check if button matches the active filter tag
                const matchesTag = activeFilter === 'all' || btnTags.split(',').map(t => t.trim()).includes(activeFilter);
                
                // Show button if it matches both search and tag filter
                button.style.display = (matchesSearch && matchesTag) ? 'flex' : 'none';
            }
        });
    }
    
    // Manually applies a filter tag and updates UI
    function filterByTagManual(tag) { 
        // Remove 'active' class from all tags
        document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
        // Find and activate the clicked tag
        const newActiveTag = document.querySelector(`.filter-tag[data-filter="${tag}"]`);
        if (newActiveTag) {
            newActiveTag.classList.add('active'); 
        } else { // Fallback to 'all' if tag not found
            document.querySelector('.filter-tag[data-filter="all"]').classList.add('active');
        }
        applyButtonVisibility(); // Re-apply visibility rules after filtering
    }
    
    // Initializes the "Recently Accessed" section
    function initializeRecentLinks() { 
        const container = document.getElementById('recentLinksContainer');
        if (!isUserAdmin() || !container) { // Only admins see this section
            if (container) container.innerHTML = ''; // Clear if not admin
            return; 
        }
        
        container.innerHTML = ''; // Clear previous items
        const links = getFromLocalStorage(RECENT_LINKS_KEY, []); // Get recent links
        
        if (links.length === 0) { // Display message if no links
            container.innerHTML = '<p style="text-align:center; color: rgba(255,255,255,0.5);">No recently accessed links.</p>';
            return; 
        }
        
        // Display up to the latest 6 recent links
        links.slice(0, 6).forEach(link => { 
            const item = document.createElement('div');
            item.className = 'recent-item';
            // Format the item content
            item.innerHTML = `
                <div class="recent-icon"><i class="${link.icon || 'fas fa-link'}"></i></div>
                <div class="recent-info">
                    <h4>${link.title || 'Untitled Link'}</h4>
                    <p>Accessed ${formatTime(link.timestamp)}</p>
                </div>
            `;
            item.onclick = () => window.open(link.url, '_blank'); // Open link in new tab on click
            container.appendChild(item);
        });
    }
    
    // Clears all recent links (for admin)
    function clearRecentLinks() { 
        if (!isUserAdmin()) return;
        if (confirm("Are you sure you want to clear all recent links?")) { 
            saveToLocalStorage(RECENT_LINKS_KEY, []); // Save empty array
            initializeRecentLinks(); // Refresh display
            showNotification("Recent links cleared.", false, "fas fa-eraser"); 
        }
    }
    
    // Formats timestamp difference into human-readable strings (e.g., "just now", "5 mins ago")
    function formatTime(timestamp) { 
        const diff = new Date() - new Date(timestamp); // Difference in milliseconds
        const s = Math.floor(diff / 1000); // Seconds
        const m = Math.floor(s / 60); // Minutes
        const h = Math.floor(m / 60); // Hours
        const d = Math.floor(h / 24); // Days

        if (d > 1) return `${d} days ago`;
        if (d === 1) return `1 day ago`;
        if (h > 1) return `${h} hours ago`;
        if (h === 1) return `1 hour ago`;
        if (m > 1) return `${m} mins ago`;
        if (m === 1) return `1 min ago`;
        return 'just now'; // Less than a minute
    }
    
    // Tracks button clicks for the "Recently Accessed" feature
    let trackedButtonListeners = new Map(); // Store listeners to be able to remove them
    function setupRecentLinkTracking() {
        // Remove existing listeners before adding new ones to prevent duplicates
        trackedButtonListeners.forEach((listener, button) => button.removeEventListener('click', listener));
        trackedButtonListeners.clear();
        
        document.querySelectorAll('#buttonContainer .btn').forEach(button => {
            // Define the listener function
            const listener = function(event) { 
                // Prevent action if button is globally disabled and user is admin (and not clicking the toggle)
                if (isUserAdmin() && this.classList.contains('globally-disabled-admin-view')) { 
                    if (!event.target.closest('.admin-toggle')) { // Allow clicking the toggle itself
                        event.preventDefault(); 
                        showNotification("Link is globally disabled. Use the admin toggle to enable.", true, "fas fa-ban"); 
                    }
                    return; // Stop further processing
                }
                // Prevent action if button is hidden (e.g., due to search/filter)
                if (this.style.display === 'none') { 
                    event.preventDefault(); 
                    return; 
                }
                
                const url = this.getAttribute('href');
                // Basic check if the link is valid/functional
                if (!url || url === '#' || url === 'javascript:void(0);') { 
                    if (this.target !== '_blank') event.preventDefault(); // Prevent default if not opening new tab
                    showNotification("This link is not functional or is a placeholder.", false, "fas fa-info-circle"); 
                    return; 
                }
                
                // Record the link access
                const title = this.querySelector('.btn-text')?.textContent.trim() || 'Unknown Link';
                const iconClass = this.querySelector('i:first-child')?.className || 'fas fa-link';
                
                let links = getFromLocalStorage(RECENT_LINKS_KEY, []);
                // Remove existing entry for this URL to keep it at the top if accessed again
                links = links.filter(l => l.url !== url);
                // Add the new entry to the beginning of the array
                links.unshift({ url, title, icon: iconClass, timestamp: new Date().toISOString() });
                
                // Save only the latest 6 links
                saveToLocalStorage(RECENT_LINKS_KEY, links.slice(0, 6));
                
                if (isUserAdmin()) {
                    initializeRecentLinks(); // Update the display if admin
                }
            };
            // Add the listener and store it
            button.addEventListener('click', listener);
            trackedButtonListeners.set(button, listener); 
        });
    }
    
    // Sets up the "Back to Top" button functionality
    function setupBackToTopButton() { 
        const btn = document.getElementById('backToTop');
        if(!btn) return; // Exit if button not found
        
        // Show/hide button based on scroll position
        window.addEventListener('scroll', () => {
            btn.style.display = (window.scrollY > 300) ? 'flex' : 'none'; // Show after scrolling 300px down
        });
        // Smooth scroll to top on click
        btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' })); 
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        // Search input listener
        document.getElementById('searchInput').addEventListener('input', filterBySearchAndTag);
        
        // Filter tag listeners
        document.querySelectorAll('.filter-tag').forEach(tag => {
            tag.addEventListener('click', function() { 
                filterByTagManual(this.dataset.filter); 
            });
        });
        
        // Login form Enter key listener
        document.getElementById('loginPopup').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && ['username','password'].includes(document.activeElement.id)) { // If Enter pressed in username/password field
                validateLogin(); // Trigger login
            }
        });
        
        // Modal close/background click listeners
        document.querySelectorAll('.modal').forEach(modal => {
            // Close button listener
            const closeBtn = modal.querySelector('.close-btn');
            if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
            // Close modal if clicking outside the content
            modal.addEventListener('click', (event) => { 
                if (event.target == modal) { // Check if the click was directly on the modal background
                    modal.style.display = 'none'; 
                }
            });
        });
        
        // Add click listeners to dashboard edit buttons
        document.querySelectorAll('.overview-card .edit-card-btn').forEach(btn => {
            btn.addEventListener('click', function() { 
                openEditDashboardModal(this.closest('.overview-card').dataset.cardId); // Get card ID from parent
            });
        });
        
        // Particle toggle checkbox listener
        document.getElementById('particleToggle').addEventListener('change', toggleParticles);
        
        // Add listener for input focus/blur to simulate placeholder effect
        document.querySelectorAll('.input-group input').forEach(input => {
            // Check initial state for pre-filled values
            if (input.value) {
                input.setAttribute('data-placeholder-shown', 'true'); // Use custom attribute for CSS targeting
            }
            // Update attribute on input change
            input.addEventListener('input', () => {
                if (input.value) {
                    input.setAttribute('data-placeholder-shown', 'true');
                } else {
                    input.removeAttribute('data-placeholder-shown'); // Remove if field is cleared
                }
            });
        });
    }

    // --- Initialization on DOM Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Record current portal version
        saveToLocalStorage(PORTAL_DATA_VERSION_KEY, CURRENT_PORTAL_VERSION);
        
        // Set up default admin user and initial data
        initializeDefaultAdmin(); 
        
        // Load and apply theme settings and particle background
        loadThemeSettings(); 
        loadParticleSetting(); 
        
        // Render buttons and set up their event listeners
        renderAllButtons(); 
        
        // Start clock and set interval for updates
        updateClock(); 
        setInterval(updateClock, 30000); // Update clock every 30 seconds
        
        // Set up "Back to Top" button
        setupBackToTopButton();
        
        // Set up all other interactive element event listeners
        setupEventListeners();
        
        // Apply initial visibility settings for sections (dashboard, recent links)
        applySectionVisibility(); 
        
        // Load initial dashboard data if admin
        loadDashboardData(); 
        
        // Create particles on initial load if enabled
        if (!document.getElementById('particles').classList.contains('hidden')) {
            createParticles();
        }
    });
    
    // Re-create particles if window is resized
    window.addEventListener('resize', () => { 
        if (!document.getElementById('particles').classList.contains('hidden')) {
            createParticles();
        }
    });
</script>
</body>
</html>
